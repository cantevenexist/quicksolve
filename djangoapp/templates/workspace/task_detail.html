{% extends 'layout.html' %}
{% block content %}
<h1 id="task-title">{{ task.title }}</h1>

<!-- Навигация -->
<div style="margin-bottom: 20px;">
    <a href="{{ task_list_url }}">← К списку задач</a>
    {% if team_detail_url %}
        | <a href="{{ team_detail_url }}">← К команде "{{ task.team.name }}"</a>
    {% endif %}
</div>

<!-- Блок информации о задаче -->
<div id="task-info-block" style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
    <h2>Информация о задаче</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <p><strong>Статус:</strong> <span id="task-status">{{ task.get_status_display }}</span></p>
            <p><strong>Приоритет:</strong> <span id="task-priority">{{ task.get_priority_display }}</span></p>
            <p><strong>Автор:</strong> 
                {{ task.reporter.username }}
                {% if user_is_reporter %}<span style="color: blue;">(Вы)</span>{% endif %}
            </p>
            <p><strong>Создана:</strong> {{ task.created_at|date:"d.m.Y H:i" }}</p>
        </div>
        <div>
            <p><strong>Исполнитель:</strong> 
                <span id="task-assignee">
                    {% if task.assignee %}
                        {{ task.assignee.username }}
                        {% if user_is_assignee %}<span style="color: blue;">(Вы)</span>{% endif %}
                    {% else %}
                        Не назначен
                    {% endif %}
                </span>
            </p>
            <p><strong>Команда:</strong> 
                <span id="task-team">
                    {% if task.team %}
                        {{ task.team.name }}
                    {% else %}
                        Без команды
                    {% endif %}
                </span>
            </p>
            <p><strong>Дедлайн:</strong> 
                <span id="task-deadline">
                    {% if task.deadline %}
                        {{ task.deadline|date:"d.m.Y H:i" }}
                        {% if is_overdue %}
                            <span style="color: red;">(Просрочено на {{ overdue_days }} дней)</span>
                        {% endif %}
                    {% else %}
                        Не установлен
                    {% endif %}
                </span>
            </p>
            <p><strong>Обновлена:</strong> 
                <span id="task-updated-info">
                    {% if task.updated_by %}
                        {{ task.updated_by.username }} в {{ task.updated_at|date:"d.m.Y H:i" }}
                    {% else %}
                        Не обновлялась
                    {% endif %}
                </span>
            </p>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <p><strong>Видимость:</strong> 
            <span id="task-visibility">
                {% if task.visible %}
                    <span style="color: green;">Открытая задача</span>
                {% else %}
                    <span style="color: orange;">Скрытая задача</span>
                {% endif %}
            </span>
        </p>
        
        <p><strong>Описание:</strong></p>
        <div id="task-description" style="padding: 10px; background-color: #f5f5f5; border-radius: 3px; min-height: 50px;">
            {% if task.description %}
                {{ task.description|linebreaks }}
            {% else %}
                <span style="color: #888;">Описание отсутствует</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Блок прав доступа -->
<div id="permissions-block" style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
    <h2>Права доступа к задаче</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <p><strong>Редакторы задачи:</strong></p>
            <ul>
                {% for editor in editors %}
                <li>
                    {{ editor.username }}
                    {% if editor == task.reporter %}<span style="color: green;">(Автор)</span>{% endif %}
                    {% if editor == request.user %}<span style="color: blue;">(Вы)</span>{% endif %}
                    {% if editor == workspace_owner %}<span style="color: purple;">(Владелец workspace)</span>{% endif %}
                    {% if editor == team_leader and task.team %}<span style="color: orange;">(Лидер команды)</span>{% endif %}
                    {% if editor == task.assignee and editor != task.reporter and editor != workspace_owner and editor != team_leader %}<span style="color: teal;">(Исполнитель)</span>{% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        <div>
            <p><strong>Права редактирования:</strong></p>
            <ul id="task-permissions-list">
                <li>Изменение содержания: <span id="perm-content">{% if task.can_edit_content %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение команды: <span id="perm-team">{% if task.can_edit_team %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение исполнителя: <span id="perm-assignee">{% if task.can_edit_assignee %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение видимости: <span id="perm-visibility">{% if task.can_edit_visibility %}✅{% else %}❌{% endif %}</span></li>
            </ul>
            
            {% if is_special_editor %}
                <p style="color: green; margin-top: 10px;">
                    <strong>⚠️ Вы являетесь специальным редактором</strong><br>
                    У вас есть все права для редактирования задачи, независимо от настроек выше.
                </p>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
        <p><em>Создатель задачи, владелец workspace {% if task.team %}и лидер команды "{{ task.team.name }}"{% endif %} всегда могут редактировать задачу.</em></p>
        <p><em>Исполнитель задачи также может редактировать её.</em></p>
        {% if task.team and is_team_editor %}
            <p><em>Вы являетесь редактором задач в команде "{{ task.team.name }}".</em></p>
        {% elif not task.team and is_workspace_editor %}
            <p><em>Вы являетесь редактором задач в рабочей области "{{ workspace.name }}".</em></p>
        {% endif %}
    </div>
</div>

<!-- Форма редактирования задачи (только для редакторов) -->
{% if is_editor %}
<div id="edit-form-block" style="border: 1px solid #007bff; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8f9fa;">
    <h2 style="color: #007bff;">Редактирование задачи</h2>
    
    <!-- Форма обновления задачи -->
    <form id="update-task-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_task">
        
        <!-- Скрытые поля для отслеживания изменений -->
        <input type="hidden" id="original-title" value="{{ task.title }}">
        <input type="hidden" id="original-status" value="{{ task.status }}">
        <input type="hidden" id="original-priority" value="{{ task.priority }}">
        <input type="hidden" id="original-description" value="{{ task.description|default_if_none:'' }}">
        <input type="hidden" id="original-team" value="{{ task.team.id|default_if_none:'' }}">
        <input type="hidden" id="original-assignee" value="{{ task.assignee.id|default_if_none:'' }}">
        <input type="hidden" id="original-visible" value="{% if task.visible %}on{% else %}off{% endif %}">
        <input type="hidden" id="original-deadline" value="{% if task.deadline %}{{ task.deadline|date:'Y-m-d\TH:i' }}{% endif %}">

        <h3>Основные параметры</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label><strong>Название задачи:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <input type="text" name="title" value="{{ task.title }}" 
                           style="width: 100%; padding: 8px;" id="edit-title" 
                           data-can-edit="true" data-original="{{ task.title }}">
                {% else %}
                    <input type="hidden" name="title" value="{{ task.title }}">
                    <p>{{ task.title }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Статус:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <select name="status" style="width: 100%; padding: 8px;" id="edit-status"
                            data-can-edit="true" data-original="{{ task.status }}">
                        {% for value, label in task.STATUS_CHOICES %}
                            <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="status" value="{{ task.status }}">
                    <p>{{ task.get_status_display }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Приоритет:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <select name="priority" style="width: 100%; padding: 8px;" id="edit-priority"
                            data-can-edit="true" data-original="{{ task.priority }}">
                        {% for value, label in task.PRIORITY_CHOICES %}
                            <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="priority" value="{{ task.priority }}">
                    <p>{{ task.get_priority_display }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Дедлайн:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <input type="datetime-local" name="deadline" 
                           value="{% if task.deadline %}{{ task.deadline|date:'Y-m-d\TH:i' }}{% endif %}" 
                           style="width: 100%; padding: 8px;" id="edit-deadline"
                           data-can-edit="true" data-original="{% if task.deadline %}{{ task.deadline|date:'Y-m-d\TH:i' }}{% endif %}">
                {% else %}
                    <input type="hidden" name="deadline" value="{% if task.deadline %}{{ task.deadline|date:'Y-m-d\TH:i' }}{% endif %}">
                    <p>{% if task.deadline %}{{ task.deadline|date:"d.m.Y H:i" }}{% else %}Не установлен{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label><strong>Описание:</strong></label>
            {% if can_edit_content or is_special_editor %}
                <textarea name="description" rows="4" style="width: 100%; padding: 8px;" 
                          id="edit-description" data-can-edit="true" data-original="{{ task.description|default_if_none:'' }}">{{ task.description }}</textarea>
            {% else %}
                <input type="hidden" name="description" value="{{ task.description|default_if_none:'' }}">
                <div style="padding: 10px; background-color: #f5f5f5; border-radius: 3px;">
                    {{ task.description|linebreaks|default:"<span style='color:#888;'>Описание отсутствует</span>" }}
                </div>
                <small style="color: #666;">(У вас нет прав для изменения)</small>
            {% endif %}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label><strong>Команда:</strong></label>
                {% if can_edit_team or is_special_editor %}
                    <select name="team" style="width: 100%; padding: 8px;" id="edit-team"
                            data-can-edit="true" data-original="{{ task.team.id|default_if_none:'' }}">
                        <option value="">Без команды</option>
                        {% for team in available_teams %}
                            <option value="{{ team.id }}" {% if task.team and task.team.id == team.id %}selected{% endif %}>
                                {{ team.name }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="team" value="{{ task.team.id|default_if_none:'' }}">
                    <p>{% if task.team %}{{ task.team.name }}{% else %}Без команды{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Исполнитель:</strong></label>
                {% if can_edit_assignee or is_special_editor %}
                    <select name="assignee" style="width: 100%; padding: 8px;" id="edit-assignee"
                            data-can-edit="true" data-original="{{ task.assignee.id|default_if_none:'' }}">
                        <option value="">Не назначено</option>
                        {% for user in available_assignees %}
                            <option value="{{ user.id }}" {% if task.assignee and task.assignee.id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="assignee" value="{{ task.assignee.id|default_if_none:'' }}">
                    <p>{% if task.assignee %}{{ task.assignee.username }}{% else %}Не назначен{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label>
                {% if can_edit_visibility or is_special_editor %}
                    <input type="checkbox" name="visible" {% if task.visible %}checked{% endif %} 
                        id="edit-visible" value="on" data-can-edit="true" 
                        data-original="{% if task.visible %}on{% else %}off{% endif %}">
                {% else %}
                    <input type="hidden" name="visible" value="{% if task.visible %}on{% else %}off{% endif %}">
                    <input type="checkbox" disabled {% if task.visible %}checked{% endif %}>
                {% endif %}
                <strong>Видимая задача</strong>
            </label>
            <br><small style="color: #666;">Если снять галочку, задачу смогут видеть только редакторы</small>
            {% if not can_edit_visibility and not is_special_editor %}
                <br><small style="color: #666;">(У вас нет прав для изменения видимости)</small>
            {% endif %}
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Сохранить изменения
            </button>
            <span id="update-task-message" style="margin-left: 15px;"></span>
        </div>
    </form>
    
    <!-- Форма изменения прав доступа (только для специальных редакторов) -->
    {% if can_change_permissions %}
    <hr style="margin: 30px 0;">
    
    <form id="update-permissions-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_permissions">
        
        <!-- Скрытые поля для неотмеченных чекбоксов -->
        <input type="hidden" name="can_edit_content" value="off">
        <input type="hidden" name="can_edit_team" value="off">
        <input type="hidden" name="can_edit_assignee" value="off">
        <input type="hidden" name="can_edit_visibility" value="off">
        
        <h3>Настройка прав доступа к задаче</h3>
        <p><small style="color: #666;">Эти настройки определяют, что могут редактировать обычные редакторы задачи (не создатель, не владелец workspace, не лидер команды).</small></p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label>
                    <input type="checkbox" name="can_edit_content" {% if task.can_edit_content %}checked{% endif %} 
                           id="perm-edit-content" value="on">
                    <strong>Можно изменять содержание</strong>
                    <br><small>Название, описание, статус, приоритет, дедлайн</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_team" {% if task.can_edit_team %}checked{% endif %} 
                           id="perm-edit-team" value="on">
                    <strong>Можно изменять команду</strong>
                    <br><small>Перенос задачи между командами</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_assignee" {% if task.can_edit_assignee %}checked{% endif %} 
                           id="perm-edit-assignee" value="on">
                    <strong>Можно изменять исполнителя</strong>
                    <br><small>Назначение/смена исполнителя задачи</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_visibility" {% if task.can_edit_visibility %}checked{% endif %} 
                           id="perm-edit-visibility" value="on">
                    <strong>Можно изменять видимость</strong>
                    <br><small>Скрытие/открытие задачи для других пользователей</small>
                </label>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Сохранить настройки прав
            </button>
            <span id="update-permissions-message" style="margin-left: 15px;"></span>
        </div>
    </form>
    {% endif %}
</div>
{% else %}
<div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8f9fa;">
    <p style="color: #666;">У вас нет прав для редактирования этой задачи. Вы можете только просматривать её.</p>
    
    {% if not task.visible %}
        <p style="color: orange;">⚠️ Эта задача скрыта. Вы видите её только потому что являетесь автором, исполнителем или редактором.</p>
    {% endif %}
</div>
{% endif %}

<!-- Блок для удаления задачи (только для пользователей с правами удаления) -->
{% if can_delete_task %}
<div style="border: 1px solid #dc3545; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8d7da;">
    <h2 style="color: #dc3545;">Опасная зона</h2>
    
    <p>Удаление задачи — необратимая операция. Все данные задачи будут безвозвратно удалены.</p>
    
    <form id="delete-task-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_task">
        
        <button type="submit" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Удалить задачу
        </button>
        <span id="delete-task-message" style="margin-left: 15px;"></span>
    </form>
</div>
{% endif %}

<!-- Сообщения от системы -->
<div id="message-container"></div>

<script>
// Функция для отображения сообщений
function showMessage(message, type = 'info') {
    const container = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    
    let bgColor, textColor, borderColor;
    switch(type) {
        case 'error':
            bgColor = '#f8d7da';
            textColor = '#721c24';
            borderColor = '#f5c6cb';
            break;
        case 'success':
            bgColor = '#d4edda';
            textColor = '#155724';
            borderColor = '#c3e6cb';
            break;
        case 'warning':
            bgColor = '#fff3cd';
            textColor = '#856404';
            borderColor = '#ffeeba';
            break;
        default:
            bgColor = '#d1ecf1';
            textColor = '#0c5460';
            borderColor = '#bee5eb';
    }
    
    messageDiv.style.cssText = `
        padding: 10px;
        margin-bottom: 10px;
        background-color: ${bgColor};
        color: ${textColor};
        border: 1px solid ${borderColor};
        border-radius: 4px;
    `;
    
    messageDiv.textContent = message;
    container.appendChild(messageDiv);
    
    // Автоматически удаляем сообщение через 5 секунд
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

// Функция для получения значения поля в зависимости от его типа
function getFieldValue(element) {
    if (!element) return '';
    
    if (element.type === 'checkbox') {
        return element.checked ? 'on' : 'off';
    } else if (element.tagName === 'SELECT') {
        return element.value;
    } else if (element.tagName === 'TEXTAREA') {
        return element.value;
    } else {
        return element.value;
    }
}

// Функция для обновления исходных значений после успешного сохранения
function updateOriginalValues(taskData) {
    // Обновляем hidden поля с исходными значениями
    if (document.getElementById('original-title')) {
        document.getElementById('original-title').value = taskData.title || '';
    }
    if (document.getElementById('original-status')) {
        document.getElementById('original-status').value = taskData.status || '';
    }
    if (document.getElementById('original-priority')) {
        document.getElementById('original-priority').value = taskData.priority || '';
    }
    if (document.getElementById('original-description')) {
        document.getElementById('original-description').value = taskData.description || '';
    }
    if (document.getElementById('original-visible')) {
        document.getElementById('original-visible').value = taskData.visible ? 'on' : 'off';
    }
    
    if (taskData.deadline) {
        const deadlineDate = new Date(taskData.deadline);
        if (document.getElementById('original-deadline')) {
            document.getElementById('original-deadline').value = deadlineDate.toISOString().slice(0, 16);
        }
    } else {
        if (document.getElementById('original-deadline')) {
            document.getElementById('original-deadline').value = '';
        }
    }
    
    if (taskData.team && taskData.team.id) {
        if (document.getElementById('original-team')) {
            document.getElementById('original-team').value = taskData.team.id.toString();
        }
    } else {
        if (document.getElementById('original-team')) {
            document.getElementById('original-team').value = '';
        }
    }
    
    if (taskData.assignee && taskData.assignee.id) {
        if (document.getElementById('original-assignee')) {
            document.getElementById('original-assignee').value = taskData.assignee.id.toString();
        }
    } else {
        if (document.getElementById('original-assignee')) {
            document.getElementById('original-assignee').value = '';
        }
    }
}

// Обновление информации о задаче на странице
function updateTaskInfo(data) {
    // Обновляем заголовок
    document.querySelector('h1').textContent = data.title;
    
    // Обновляем статус
    document.getElementById('task-status').textContent = data.status_display;
    
    // Обновляем приоритет
    document.getElementById('task-priority').textContent = data.priority_display;
    
    // Обновляем дедлайн
    const deadlineElement = document.getElementById('task-deadline');
    deadlineElement.innerHTML = '';
    if (data.deadline_display && data.deadline_display !== 'Не установлен') {
        deadlineElement.textContent = data.deadline_display;
        if (data.is_overdue) {
            const overdueSpan = document.createElement('span');
            overdueSpan.style.color = 'red';
            overdueSpan.textContent = ' (Просрочено)';
            deadlineElement.appendChild(overdueSpan);
        }
    } else {
        deadlineElement.textContent = 'Не установлен';
    }
    
    // Обновляем исполнителя
    const assigneeElement = document.getElementById('task-assignee');
    assigneeElement.innerHTML = '';
    if (data.assignee) {
        assigneeElement.textContent = data.assignee.username;
        if (data.assignee.username === '{{ request.user.username }}') {
            const youSpan = document.createElement('span');
            youSpan.style.color = 'blue';
            youSpan.textContent = ' (Вы)';
            assigneeElement.appendChild(youSpan);
        }
    } else {
        assigneeElement.textContent = 'Не назначен';
    }
    
    // Обновляем команду
    const teamElement = document.getElementById('task-team');
    if (data.team) {
        teamElement.textContent = data.team.name;
    } else {
        teamElement.textContent = 'Без команды';
    }
    
    // Обновляем описание
    const descriptionElement = document.getElementById('task-description');
    descriptionElement.innerHTML = '';
    if (data.description) {
        descriptionElement.innerHTML = data.description.replace(/\n/g, '<br>');
    } else {
        descriptionElement.innerHTML = '<span style="color: #888;">Описание отсутствует</span>';
    }
    
    // Обновляем видимость
    const visibilityElement = document.getElementById('task-visibility');
    visibilityElement.innerHTML = '';
    if (data.visible) {
        const visibleSpan = document.createElement('span');
        visibleSpan.style.color = 'green';
        visibleSpan.textContent = 'Открытая задача';
        visibilityElement.appendChild(visibleSpan);
    } else {
        const hiddenSpan = document.createElement('span');
        hiddenSpan.style.color = 'orange';
        hiddenSpan.textContent = 'Скрытая задача';
        visibilityElement.appendChild(hiddenSpan);
    }
    
    // Обновляем информацию об обновлении
    const updatedElement = document.getElementById('task-updated-info');
    if (data.updated_by) {
        const now = new Date();
        const formattedDate = now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
        updatedElement.textContent = `${data.updated_by} в ${formattedDate}`;
    }
    
    // Обновляем значения в форме редактирования
    const editTitle = document.getElementById('edit-title');
    if (editTitle) editTitle.value = data.title;
    
    const editStatus = document.getElementById('edit-status');
    if (editStatus) editStatus.value = data.status;
    
    const editPriority = document.getElementById('edit-priority');
    if (editPriority) editPriority.value = data.priority;
    
    const editDeadline = document.getElementById('edit-deadline');
    if (editDeadline) {
        if (data.deadline) {
            const deadlineDate = new Date(data.deadline);
            editDeadline.value = deadlineDate.toISOString().slice(0, 16);
        } else {
            editDeadline.value = '';
        }
    }
    
    const editDescription = document.getElementById('edit-description');
    if (editDescription) editDescription.value = data.description || '';
    
    const editTeam = document.getElementById('edit-team');
    if (editTeam && data.team) {
        editTeam.value = data.team.id;
    } else if (editTeam) {
        editTeam.value = '';
    }
    
    const editAssignee = document.getElementById('edit-assignee');
    if (editAssignee && data.assignee) {
        editAssignee.value = data.assignee.id;
    } else if (editAssignee) {
        editAssignee.value = '';
    }
    
    const editVisible = document.getElementById('edit-visible');
    if (editVisible) editVisible.checked = data.visible;
    
    // Обновляем исходные значения
    updateOriginalValues(data);
}

// Обновление прав доступа на странице
function updatePermissions(data) {
    // Обновляем иконки прав
    document.getElementById('perm-content').textContent = data.can_edit_content ? '✅' : '❌';
    document.getElementById('perm-team').textContent = data.can_edit_team ? '✅' : '❌';
    document.getElementById('perm-assignee').textContent = data.can_edit_assignee ? '✅' : '❌';
    document.getElementById('perm-visibility').textContent = data.can_edit_visibility ? '✅' : '❌';
    
    // Обновляем чекбоксы в форме
    const permContentCheckbox = document.getElementById('perm-edit-content');
    if (permContentCheckbox) permContentCheckbox.checked = data.can_edit_content;
    
    const permTeamCheckbox = document.getElementById('perm-edit-team');
    if (permTeamCheckbox) permTeamCheckbox.checked = data.can_edit_team;
    
    const permAssigneeCheckbox = document.getElementById('perm-edit-assignee');
    if (permAssigneeCheckbox) permAssigneeCheckbox.checked = data.can_edit_assignee;
    
    const permVisibilityCheckbox = document.getElementById('perm-edit-visibility');
    if (permVisibilityCheckbox) permVisibilityCheckbox.checked = data.can_edit_visibility;
}

// Обработка формы обновления задачи
document.addEventListener('DOMContentLoaded', function() {
    const updateTaskForm = document.getElementById('update-task-form');
    if (updateTaskForm) {
        updateTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Создаем FormData с базовыми данными
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', this.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('action', 'update_task');
            
            // Собираем только измененные поля, которые пользователь может редактировать
            const fields = [
                {id: 'edit-title', name: 'title', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-status', name: 'status', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-priority', name: 'priority', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-description', name: 'description', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-deadline', name: 'deadline', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-team', name: 'team', canEdit: {{ can_edit_team|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-assignee', name: 'assignee', canEdit: {{ can_edit_assignee|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
            ];
            
            let hasChanges = false;
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    const currentValue = getFieldValue(element);
                    const originalElement = document.getElementById(`original-${field.name}`);
                    const originalValue = originalElement ? originalElement.value : '';
                    
                    // Если поле можно редактировать и значение изменилось
                    if (field.canEdit && currentValue !== originalValue) {
                        formData.append(field.name, currentValue);
                        hasChanges = true;
                    } else if (!field.canEdit && originalElement) {
                        // Если нельзя редактировать, отправляем исходное значение
                        formData.append(field.name, originalValue);
                    }
                }
            });
            
            // Обработка чекбокса видимости
            const visibleCheckbox = document.getElementById('edit-visible');
            if (visibleCheckbox) {
                const currentValue = visibleCheckbox.checked ? 'on' : 'off';
                const originalElement = document.getElementById('original-visible');
                const originalValue = originalElement ? originalElement.value : '';
                const canEditVisibility = {{ can_edit_visibility|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }};
                
                if (canEditVisibility && currentValue !== originalValue) {
                    formData.append('visible', currentValue);
                    hasChanges = true;
                } else if (!canEditVisibility && originalElement) {
                    formData.append('visible', originalValue);
                }
            }
            
            // Валидация только если есть изменения
            if (hasChanges) {
                // Проверяем название задачи (если оно изменялось)
                const titleElement = document.getElementById('edit-title');
                if (titleElement && titleElement.getAttribute('data-can-edit') === 'true') {
                    const titleValue = getFieldValue(titleElement);
                    if (!titleValue || titleValue.trim().length === 0) {
                        showMessage('Название задачи не может быть пустым', 'error');
                        return;
                    }
                }
                
                const messageElement = document.getElementById('update-task-message');
                messageElement.textContent = 'Сохранение...';
                messageElement.style.color = '#666';
                
                fetch('', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        messageElement.textContent = '✓ ' + data.message;
                        messageElement.style.color = 'green';
                        showMessage(data.message, 'success');
                        
                        // Обновляем информацию на странице
                        if (data.task_data) {
                            updateTaskInfo(data.task_data);
                        }
                    } else {
                        messageElement.textContent = '✗ Ошибка';
                        messageElement.style.color = 'red';
                        
                        if (data.errors && Array.isArray(data.errors)) {
                            data.errors.forEach(error => showMessage(error, 'error'));
                        } else if (data.error) {
                            showMessage(data.error, 'error');
                        }
                    }
                    
                    // Очищаем сообщение через 3 секунды
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = '✗ Ошибка сети';
                    messageElement.style.color = 'red';
                    showMessage('Ошибка сети при сохранении: ' + error.message, 'error');
                    
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                });
            } else {
                showMessage('Нет изменений для сохранения', 'info');
            }
        });
    }
    
    // Обработка формы обновления прав доступа
    const updatePermissionsForm = document.getElementById('update-permissions-form');
    if (updatePermissionsForm) {
        updatePermissionsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Удаляем скрытые поля, если чекбокс отмечен
            const formData = new FormData(this);
            const checkboxes = ['can_edit_content', 'can_edit_team', 'can_edit_assignee', 'can_edit_visibility'];
            
            checkboxes.forEach(field => {
                if (formData.get(field) === 'on') {
                    // Удаляем скрытое поле, так как чекбокс отмечен
                    const hiddenField = this.querySelector(`input[type="hidden"][name="${field}"]`);
                    if (hiddenField) {
                        hiddenField.remove();
                    }
                }
            });
            
            const messageElement = document.getElementById('update-permissions-message');
            messageElement.textContent = 'Сохранение...';
            messageElement.style.color = '#666';
            
            fetch('', {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    messageElement.textContent = '✓ ' + data.message;
                    messageElement.style.color = 'green';
                    showMessage(data.message, 'success');
                    
                    // Обновляем права на странице
                    if (data.permissions) {
                        updatePermissions(data.permissions);
                    }
                } else {
                    messageElement.textContent = '✗ Ошибка';
                    messageElement.style.color = 'red';
                    showMessage(data.error, 'error');
                }
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.textContent = '✗ Ошибка сети';
                messageElement.style.color = 'red';
                showMessage('Ошибка сети при сохранении: ' + error.message, 'error');
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            });
        });
    }
    
    // Обработка формы удаления задачи
    const deleteTaskForm = document.getElementById('delete-task-form');
    if (deleteTaskForm) {
        deleteTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('Вы уверены, что хотите удалить задачу «{{ task.title }}»? Это действие нельзя отменить.')) {
                return;
            }
            
            const formData = new FormData(this);
            const messageElement = document.getElementById('delete-task-message');
            messageElement.textContent = 'Удаление...';
            messageElement.style.color = '#666';
            
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    messageElement.textContent = '✓ ' + data.message;
                    messageElement.style.color = 'green';
                    showMessage(data.message, 'success');
                    
                    // Перенаправляем через 2 секунды
                    setTimeout(() => {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                    }, 2000);
                } else {
                    messageElement.textContent = '✗ Ошибка';
                    messageElement.style.color = 'red';
                    showMessage(data.error, 'error');
                    
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.textContent = '✗ Ошибка сети';
                messageElement.style.color = 'red';
                showMessage('Ошибка сети при удалении: ' + error.message, 'error');
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            });
        });
    }
});
</script>

{% endblock %}