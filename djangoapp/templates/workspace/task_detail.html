{% extends 'layout.html' %}
{% block content %}
<h1 id="task-title">{{ task.title }}</h1>

<!-- Навигация -->
<div style="margin-bottom: 20px;">
    <a href="{{ task_list_url }}">← К списку задач</a>
    {% if team_detail_url %}
        | <a href="{{ team_detail_url }}">← К команде "{{ task.team.name }}"</a>
    {% endif %}
</div>

<!-- Блок информации о задаче -->
<div id="task-info-block" style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
    <h2>Информация о задаче</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <p><strong>Статус:</strong> <span id="task-status">{{ task.get_status_display }}</span></p>
            <p><strong>Приоритет:</strong> <span id="task-priority">{{ task.get_priority_display }}</span></p>
            <p><strong>Автор:</strong> 
                {{ task.reporter.username }}
                {% if user_is_reporter %}<span style="color: blue;">(Вы)</span>{% endif %}
            </p>
            <p><strong>Создана:</strong> 
                <span class="utc-time" data-utc="{{ task.created_at.isoformat }}">
                    {{ task.created_at|date:"d.m.Y H:i" }}
                </span>
            </p>
        </div>
        <div>
            <p><strong>Исполнитель:</strong> 
                <span id="task-assignee">
                    {% if task.assignee %}
                        {{ task.assignee.username }}
                        {% if user_is_assignee %}<span style="color: blue;">(Вы)</span>{% endif %}
                    {% else %}
                        Не назначен
                    {% endif %}
                </span>
            </p>
            <p><strong>Команда:</strong> 
                <span id="task-team">
                    {% if task.team %}
                        {{ task.team.name }}
                    {% else %}
                        Без команды
                    {% endif %}
                </span>
            </p>
            <p><strong>Дедлайн:</strong> 
                <span id="task-deadline" class="utc-time" data-utc="{% if task.deadline %}{{ task.deadline.isoformat }}{% endif %}">
                    {% if task.deadline %}
                        {{ task.deadline|date:"d.m.Y H:i" }}
                    {% else %}
                        Не установлен
                    {% endif %}
                </span>
                <span id="overdue-text" class="overdue-text" style="color: red;">
                    {% if is_overdue %}
                        (Просрочено на {{ overdue_days }} дней)
                    {% endif %}
                </span>
            </p>
            <p><strong>Обновлена:</strong> 
                <span id="task-updated-info">
                    {% if task.updated_by %}
                        {{ task.updated_by.username }} в 
                        <span class="utc-time" data-utc="{{ task.updated_at.isoformat }}">
                            {{ task.updated_at|date:"d.m.Y H:i" }}
                        </span>
                    {% else %}
                        Не обновлялась
                    {% endif %}
                </span>
            </p>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <p><strong>Видимость:</strong> 
            <span id="task-visibility">
                {% if task.visible %}
                    <span style="color: green;">Открытая задача</span>
                {% else %}
                    <span style="color: orange;">Скрытая задача</span>
                {% endif %}
            </span>
        </p>
        
        <p><strong>Описание:</strong></p>
        <div id="task-description" style="padding: 10px; background-color: #f5f5f5; border-radius: 3px">
            {% if task.description %}
<p style="text-indent: 0; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">{{ task.description }}</p>
            {% else %}
                <span style="color: #888;">Описание отсутствует</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Блок прав доступа -->
<div id="permissions-block" style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
    <h2>Права доступа к задаче</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
            <p><strong>Редакторы задачи:</strong></p>
            <ul>
                {% for editor in editors %}
                <li>
                    {{ editor.username }}
                    {% if editor == task.reporter %}<span style="color: green;">(Автор)</span>{% endif %}
                    {% if editor == request.user %}<span style="color: blue;">(Вы)</span>{% endif %}
                    {% if editor == workspace_owner %}<span style="color: purple;">(Владелец workspace)</span>{% endif %}
                    {% if editor == team_leader and task.team %}<span style="color: orange;">(Лидер команды)</span>{% endif %}
                    {% if editor == task.assignee and editor != task.reporter and editor != workspace_owner and editor != team_leader %}<span style="color: teal;">(Исполнитель)</span>{% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        <div>
            <p><strong>Права редактирования:</strong></p>
            <ul id="task-permissions-list">
                <li>Изменение содержания: <span id="perm-content">{% if task.can_edit_content %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение команды: <span id="perm-team">{% if task.can_edit_team %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение исполнителя: <span id="perm-assignee">{% if task.can_edit_assignee %}✅{% else %}❌{% endif %}</span></li>
                <li>Изменение видимости: <span id="perm-visibility">{% if task.can_edit_visibility %}✅{% else %}❌{% endif %}</span></li>
            </ul>
            
            {% if is_special_editor %}
                <p style="color: green; margin-top: 10px;">
                    <strong>⭐️ Вы являетесь специальным редактором</strong><br>
                    У вас есть все права для редактирования задачи, независимо от настроек выше.
                </p>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
        <p><em>Создатель задачи, владелец workspace {% if task.team %}и лидер команды "{{ task.team.name }}"{% endif %} всегда могут редактировать задачу.</em></p>
        <p><em>Исполнитель задачи также может редактировать её.</em></p>
        {% if task.team and is_team_editor %}
            <p><em>Вы являетесь редактором задач в команде "{{ task.team.name }}".</em></p>
        {% elif not task.team and is_workspace_editor %}
            <p><em>Вы являетесь редактором задач в рабочей области "{{ workspace.name }}".</em></p>
        {% endif %}
    </div>
</div>

<!-- Форма редактирования задачи (только для редакторов) -->
{% if is_editor %}
<div id="edit-form-block" style="border: 1px solid #007bff; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8f9fa;">
    <h2 style="color: #007bff;">Редактирование задачи</h2>
    
    <!-- Форма обновления задачи -->
    <form id="update-task-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_task">
        
        <!-- Скрытые поля для отслеживания изменений -->
        <input type="hidden" id="original-title" value="{{ task.title }}">
        <input type="hidden" id="original-status" value="{{ task.status }}">
        <input type="hidden" id="original-priority" value="{{ task.priority }}">
        <input type="hidden" id="original-description" value="{{ task.description|default_if_none:'' }}">
        <input type="hidden" id="original-team" value="{{ task.team.id|default_if_none:'' }}">
        <input type="hidden" id="original-assignee" value="{{ task.assignee.id|default_if_none:'' }}">
        <input type="hidden" id="original-visible" value="{% if task.visible %}on{% else %}off{% endif %}">
        <!-- Храним дедлайн в UTC формате -->
        <input type="hidden" id="original-deadline-utc" value="{% if task.deadline %}{{ task.deadline.isoformat }}{% endif %}">

        <h3>Основные параметры</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label><strong>Название задачи:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <input type="text" name="title" value="{{ task.title }}" 
                           style="width: 100%; padding: 8px;" id="edit-title" 
                           data-can-edit="true" data-original="{{ task.title }}">
                {% else %}
                    <input type="hidden" name="title" value="{{ task.title }}">
                    <p>{{ task.title }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Статус:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <select name="status" style="width: 100%; padding: 8px;" id="edit-status"
                            data-can-edit="true" data-original="{{ task.status }}">
                        {% for value, label in task.STATUS_CHOICES %}
                            <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="status" value="{{ task.status }}">
                    <p>{{ task.get_status_display }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Приоритет:</strong></label>
                {% if can_edit_content or is_special_editor %}
                    <select name="priority" style="width: 100%; padding: 8px;" id="edit-priority"
                            data-can-edit="true" data-original="{{ task.priority }}">
                        {% for value, label in task.PRIORITY_CHOICES %}
                            <option value="{{ value }}" {% if task.priority == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="priority" value="{{ task.priority }}">
                    <p>{{ task.get_priority_display }}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Дедлайн (ваше местное время):</strong></label>
                {% if can_edit_content or is_special_editor %}
                    {% if task.deadline %}
                        <input type="datetime-local" name="deadline" 
                               value="" 
                               style="width: 100%; padding: 8px;" id="edit-deadline"
                               data-can-edit="true" data-original="">
                    {% else %}
                        <input type="datetime-local" name="deadline" 
                               value="" 
                               style="width: 100%; padding: 8px;" id="edit-deadline"
                               data-can-edit="true" data-original="">
                    {% endif %}
                {% else %}
                    <input type="hidden" name="deadline" value="">
                    <p class="utc-time" data-utc="{% if task.deadline %}{{ task.deadline.isoformat }}{% endif %}">{% if task.deadline %}{{ task.deadline|date:"d.m.Y H:i" }}{% else %}Не установлен{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
                <small style="color: #666; display: block; margin-top: 5px;">
                    Указывается в вашем локальном времени
                </small>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label><strong>Описание:</strong></label>
            {% if can_edit_content or is_special_editor %}
                <textarea name="description" rows="4" style="width: 100%; padding: 8px;" 
                          id="edit-description" data-can-edit="true" data-original="{{ task.description|default_if_none:'' }}">{{ task.description }}</textarea>
            {% else %}
                <input type="hidden" name="description" value="{{ task.description|default_if_none:'' }}">
                <div style="padding: 10px; background-color: #f5f5f5; border-radius: 3px;">
                    {{ task.description|linebreaks|default:"<span style='color:#888;'>Описание отсутствует</span>" }}
                </div>
                <small style="color: #666;">(У вас нет прав для изменения)</small>
            {% endif %}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label><strong>Команда:</strong></label>
                {% if can_edit_team or is_special_editor %}
                    <select name="team" style="width: 100%; padding: 8px;" id="edit-team"
                            data-can-edit="true" data-original="{{ task.team.id|default_if_none:'' }}">
                        <option value="">Без команды</option>
                        {% for team in available_teams %}
                            <option value="{{ team.id }}" {% if task.team and task.team.id == team.id %}selected{% endif %}>
                                {{ team.name }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="team" value="{{ task.team.id|default_if_none:'' }}">
                    <p>{% if task.team %}{{ task.team.name }}{% else %}Без команды{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
            
            <div>
                <label><strong>Исполнитель:</strong></label>
                {% if can_edit_assignee or is_special_editor %}
                    <select name="assignee" style="width: 100%; padding: 8px;" id="edit-assignee"
                            data-can-edit="true" data-original="{{ task.assignee.id|default_if_none:'' }}">
                        <option value="">Не назначено</option>
                        {% for user in available_assignees %}
                            <option value="{{ user.id }}" {% if task.assignee and task.assignee.id == user.id %}selected{% endif %}>
                                {{ user.username }}
                            </option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input type="hidden" name="assignee" value="{{ task.assignee.id|default_if_none:'' }}">
                    <p>{% if task.assignee %}{{ task.assignee.username }}{% else %}Не назначен{% endif %}</p>
                    <small style="color: #666;">(У вас нет прав для изменения)</small>
                {% endif %}
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label>
                {% if can_edit_visibility or is_special_editor %}
                    <input type="checkbox" name="visible" {% if task.visible %}checked{% endif %} 
                        id="edit-visible" value="on" data-can-edit="true" 
                        data-original="{% if task.visible %}on{% else %}off{% endif %}">
                {% else %}
                    <input type="hidden" name="visible" value="{% if task.visible %}on{% else %}off{% endif %}">
                    <input type="checkbox" disabled {% if task.visible %}checked{% endif %}>
                {% endif %}
                <strong>Видимая задача</strong>
            </label>
            <br><small style="color: #666;">Если снять галочку, задачу смогут видеть только редакторы</small>
            {% if not can_edit_visibility and not is_special_editor %}
                <br><small style="color: #666;">(У вас нет прав для изменения видимости)</small>
            {% endif %}
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Сохранить изменения
            </button>
            <span id="update-task-message" style="margin-left: 15px;"></span>
        </div>
    </form>
    
    <!-- Форма изменения прав доступа (только для специальных редакторов) -->
    {% if can_change_permissions %}
    <hr style="margin: 30px 0;">
    
    <form id="update-permissions-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_permissions">
        
        <!-- Скрытые поля для неотмеченных чекбоксов -->
        <input type="hidden" name="can_edit_content" value="off">
        <input type="hidden" name="can_edit_team" value="off">
        <input type="hidden" name="can_edit_assignee" value="off">
        <input type="hidden" name="can_edit_visibility" value="off">
        
        <h3>Настройка прав доступа к задаче</h3>
        <p><small style="color: #666;">Эти настройки определяют, что могут редактировать обычные редакторы задачи (не создатель, не владелец workspace, не лидер команды).</small></p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div>
                <label>
                    <input type="checkbox" name="can_edit_content" {% if task.can_edit_content %}checked{% endif %} 
                           id="perm-edit-content" value="on">
                    <strong>Можно изменять содержание</strong>
                    <br><small>Название, описание, статус, приоритет, дедлайн</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_team" {% if task.can_edit_team %}checked{% endif %} 
                           id="perm-edit-team" value="on">
                    <strong>Можно изменять команду</strong>
                    <br><small>Перенос задачи между командами</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_assignee" {% if task.can_edit_assignee %}checked{% endif %} 
                           id="perm-edit-assignee" value="on">
                    <strong>Можно изменять исполнителя</strong>
                    <br><small>Назначение/смена исполнителя задачи</small>
                </label>
            </div>
            
            <div>
                <label>
                    <input type="checkbox" name="can_edit_visibility" {% if task.can_edit_visibility %}checked{% endif %} 
                           id="perm-edit-visibility" value="on">
                    <strong>Можно изменять видимость</strong>
                    <br><small>Скрытие/открытие задачи для других пользователей</small>
                </label>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Сохранить настройки прав
            </button>
            <span id="update-permissions-message" style="margin-left: 15px;"></span>
</div>
    </form>
    {% endif %}
</div>
{% else %}
<div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8f9fa;">
    <p style="color: #666;">У вас нет прав для редактирования этой задачи. Вы можете только просматривать её.</p>
    
    {% if not task.visible %}
        <p style="color: orange;">⚠️ Эта задача скрыта. Вы видите её только потому что являетесь автором, исполнителем или редактором.</p>
    {% endif %}
</div>
{% endif %}

<!-- Блок для удаления задачи (только для пользователей с правами удаления) -->
{% if can_delete_task %}
<div style="border: 1px solid #dc3545; padding: 20px; margin-bottom: 30px; border-radius: 5px; background-color: #f8d7da;">
    <h2 style="color: #dc3545;">Опасная зона</h2>
    
    <p>Удаление задачи — необратимая операция. Все данные задачи будут безвозвратно удалены.</p>
    
    <form id="delete-task-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_task">
        
        <button type="submit" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Удалить задачу
        </button>
        <span id="delete-task-message" style="margin-left: 15px;"></span>
    </form>
</div>
{% endif %}

<!-- Сообщения от системы -->
<div id="message-container"></div>

<script>
// Функция для отображения сообщений
function showMessage(message, type = 'info') {
    const container = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    
    let bgColor, textColor, borderColor;
    switch(type) {
        case 'error':
            bgColor = '#f8d7da';
            textColor = '#721c24';
            borderColor = '#f5c6cb';
            break;
        case 'success':
            bgColor = '#d4edda';
            textColor = '#155724';
            borderColor = '#c3e6cb';
            break;
        case 'warning':
            bgColor = '#fff3cd';
            textColor = '#856404';
            borderColor = '#ffeeba';
            break;
        default:
            bgColor = '#d1ecf1';
            textColor = '#0c5460';
            borderColor = '#bee5eb';
    }
    
    messageDiv.style.cssText = `
        padding: 10px;
        margin-bottom: 10px;
        background-color: ${bgColor};
        color: ${textColor};
        border: 1px solid ${borderColor};
        border-radius: 4px;
    `;
    
    messageDiv.textContent = message;
    container.appendChild(messageDiv);
    
    // Автоматически удаляем сообщение через 5 секунд
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

// Функция для конвертации всех UTC времен в локальное время пользователя
function convertAllTimes() {
    // Находим все элементы с классом utc-time и data-utc атрибутом
    const timeElements = document.querySelectorAll('.utc-time[data-utc]');
    
    timeElements.forEach(element => {
        const utcString = element.getAttribute('data-utc');
        if (utcString && utcString.trim() !== '') {
            try {
                const utcDate = new Date(utcString);
                
                // Форматируем дату в локальное время пользователя
                const localDate = utcDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                const localTime = utcDate.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                // Сохраняем оригинальный текст для восстановления при необходимости
                if (!element.dataset.originalText) {
                    element.dataset.originalText = element.textContent;
                }
                
                // Обновляем текст элемента
                element.textContent = `${localDate} ${localTime}`;
                
                // Добавляем тултип с информацией о UTC времени
                element.title = `UTC: ${utcString.replace('T', ' ').slice(0, 16)}`;
                
            } catch (error) {
                console.error('Ошибка конвертации времени:', error, 'UTC строка:', utcString);
            }
        }
    });
    
    // Также обновляем поле дедлайна в форме редактирования
    const deadlineInput = document.getElementById('edit-deadline');
    if (deadlineInput) {
        const originalUTC = document.getElementById('original-deadline-utc')?.value;
        if (originalUTC && originalUTC.trim() !== '') {
            try {
                const utcDate = new Date(originalUTC);
                // Преобразуем UTC в локальное время для input[type="datetime-local"]
                const localDate = new Date(utcDate.getTime() - (utcDate.getTimezoneOffset() * 60000));
                deadlineInput.value = localDate.toISOString().slice(0, 16);
            } catch (error) {
                console.error('Ошибка конвертации дедлайна:', error);
            }
        }
    }
}

// Функция для получения значения поля в зависимости от его типа
function getFieldValue(element) {
    if (!element) return '';
    
    if (element.type === 'checkbox') {
        return element.checked ? 'on' : 'off';
    } else if (element.tagName === 'SELECT') {
        return element.value;
    } else if (element.tagName === 'TEXTAREA') {
        return element.value;
    } else {
        return element.value;
    }
}

// Функция для преобразования локального времени в строку для отправки
function localDateTimeToLocalString(localDateTimeString) {
    if (!localDateTimeString) return '';
    // Добавляем секунды для корректного парсинга Django
    return localDateTimeString + ':00';
}

// Функция для преобразования локального времени в UTC
function localDateTimeToUTC(localDateTimeString) {

    if (!localDateTimeString) return '';
    
    try {
        // Браузер интерпретирует строку как локальное время
        const localDate = new Date(localDateTimeString); // Добавляем Z чтобы избежать проблем
        
        // Получаем время в UTC
        const utcYear = localDate.getUTCFullYear();
        const utcMonth = String(localDate.getUTCMonth() + 1).padStart(2, '0');
        const utcDay = String(localDate.getUTCDate()).padStart(2, '0');
        const utcHours = String(localDate.getUTCHours()).padStart(2, '0');
        const utcMinutes = String(localDate.getUTCMinutes()).padStart(2, '0');
        
        // Формат: YYYY-MM-DD HH:MM:SS (для Django)
        return `${utcYear}-${utcMonth}-${utcDay} ${utcHours}:${utcMinutes}:00`;
    } catch (error) {
        console.error('Ошибка конвертации времени в UTC:', error);
        return '';
    }
}

// Функция для преобразования UTC в локальное время
function utcToLocalDateTime(utcString) {
    if (!utcString) return '';
    
    try {
        const utcDate = new Date(utcString + 'Z'); // Добавляем Z для указания UTC
        
        // Преобразуем UTC в локальное время для input
        const localDate = new Date(utcDate.getTime() - (utcDate.getTimezoneOffset() * 60000));
        return localDate.toISOString().slice(0, 16);
    } catch (error) {
        console.error('Ошибка конвертации UTC в локальное время:', error);
        return '';
    }
}

// Функция для обновления исходных значений после успешного сохранения
function updateOriginalValues(taskData) {
    // Обновляем hidden поля с исходными значениями
    if (document.getElementById('original-title')) {
        document.getElementById('original-title').value = taskData.title || '';
    }
    if (document.getElementById('original-status')) {
        document.getElementById('original-status').value = taskData.status || '';
    }
    if (document.getElementById('original-priority')) {
        document.getElementById('original-priority').value = taskData.priority || '';
    }
    if (document.getElementById('original-description')) {
        document.getElementById('original-description').value = taskData.description || '';
    }
    if (document.getElementById('original-visible')) {
        document.getElementById('original-visible').value = taskData.visible ? 'on' : 'off';
    }
    
    // Обновляем дедлайн в UTC формате
    if (taskData.deadline) {
        if (document.getElementById('original-deadline-utc')) {
            document.getElementById('original-deadline-utc').value = taskData.deadline;
        }
    } else {
        if (document.getElementById('original-deadline-utc')) {
            document.getElementById('original-deadline-utc').value = '';
        }
    }
    
    if (taskData.team && taskData.team.id) {
        if (document.getElementById('original-team')) {
            document.getElementById('original-team').value = taskData.team.id.toString();
        }
    } else {
        if (document.getElementById('original-team')) {
            document.getElementById('original-team').value = '';
        }
    }
    
    if (taskData.assignee && taskData.assignee.id) {
        if (document.getElementById('original-assignee')) {
            document.getElementById('original-assignee').value = taskData.assignee.id.toString();
        }
    } else {
        if (document.getElementById('original-assignee')) {
            document.getElementById('original-assignee').value = '';
        }
    }
}

// Функция для проверки изменений в правах доступа
function checkPermissionsChanges() {
    const checkboxes = [
        {id: 'perm-edit-content', name: 'can_edit_content'},
        {id: 'perm-edit-team', name: 'can_edit_team'},
        {id: 'perm-edit-assignee', name: 'can_edit_assignee'},
        {id: 'perm-edit-visibility', name: 'can_edit_visibility'}
    ];
    
    let hasChanges = false;
    
    checkboxes.forEach(field => {
        const checkbox = document.getElementById(field.id);
        if (checkbox) {
            const currentValue = checkbox.checked;
            // Получаем исходное состояние из данных чекбокса
            if (checkbox.dataset.originalValue === undefined) {
                // Сохраняем исходное значение при первом вызове
                checkbox.dataset.originalValue = checkbox.checked.toString();
            }
            
            const originalValue = checkbox.dataset.originalValue === 'true';
            
            if (currentValue !== originalValue) {
                hasChanges = true;
                console.log(`Право ${field.name} изменилось:`, {
                    старое: originalValue,
                    новое: currentValue
                });
            }
        }
    });
    
    return hasChanges;
}

// Функция для обновления исходных значений прав доступа
function updatePermissionsOriginalValues() {
    const checkboxes = ['perm-edit-content', 'perm-edit-team', 'perm-edit-assignee', 'perm-edit-visibility'];
    
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.dataset.originalValue = checkbox.checked.toString();
        }
    });
}

// Обновление информации о задаче на странице
function updateTaskInfo(data) {
    // Обновляем заголовок
    document.querySelector('h1').textContent = data.title;
    
    // Обновляем статус
    document.getElementById('task-status').textContent = data.status_display;
    
    // Обновляем приоритет
    document.getElementById('task-priority').textContent = data.priority_display;
    
    // Обновляем дедлайн
    const deadlineElement = document.getElementById('task-deadline');
    if (deadlineElement) {
        deadlineElement.innerHTML = '';
        
        if (data.deadline) {
            // Обновляем data-utc атрибут
            deadlineElement.setAttribute('data-utc', data.deadline);
            
            // Временно отображаем время в формате UTC
            const utcDate = new Date(data.deadline);
            const utcDateStr = utcDate.toISOString().slice(0, 16).replace('T', ' ');
            deadlineElement.textContent = utcDateStr;

            if (data.overdue_days) {
                const overdueSpan = document.getElementById('overdue-text');
                overdueSpan.innerHTML = '(Просрочено на '+data.overdue_days+' дней)';
            } else {
                const overdueSpan = document.getElementById('overdue-text');
                overdueSpan.innerHTML = '';
            }
        } else {
            deadlineElement.textContent = 'Не установлен';
            deadlineElement.removeAttribute('data-utc');
        }
    }
    
    // Обновляем исполнителя
    const assigneeElement = document.getElementById('task-assignee');
    if (assigneeElement) {
        assigneeElement.innerHTML = '';
        if (data.assignee) {
            assigneeElement.textContent = data.assignee.username;
            if (data.assignee.username === '{{ request.user.username }}') {
                const youSpan = document.createElement('span');
                youSpan.style.color = 'blue';
                youSpan.textContent = ' (Вы)';
                assigneeElement.appendChild(youSpan);
            }
        } else {
            assigneeElement.textContent = 'Не назначен';
        }
    }
    
    // Обновляем команду
    const teamElement = document.getElementById('task-team');
    if (teamElement) {
        if (data.team) {
            teamElement.textContent = data.team.name;
        } else {
            teamElement.textContent = 'Без команды';
        }
    }
    
    // Обновляем описание
    const descriptionElement = document.getElementById('task-description');
    if (descriptionElement) {
        descriptionElement.innerHTML = '';
        if (data.description) {
            descriptionElement.innerHTML = '<p style="text-indent: 0; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;">'+data.description+'</p>';
        } else {
            descriptionElement.innerHTML = '<span style="color: #888;">Описание отсутствует</span>';
        }
    }
    
    // Обновляем видимость
    const visibilityElement = document.getElementById('task-visibility');
    if (visibilityElement) {
        visibilityElement.innerHTML = '';
        if (data.visible) {
            const visibleSpan = document.createElement('span');
            visibleSpan.style.color = 'green';
            visibleSpan.textContent = 'Открытая задача';
            visibilityElement.appendChild(visibleSpan);
        } else {
            const hiddenSpan = document.createElement('span');
            hiddenSpan.style.color = 'orange';
            hiddenSpan.textContent = 'Скрытая задача';
            visibilityElement.appendChild(hiddenSpan);
        }
    }
    
    // Обновляем информацию об обновлении
    const updatedElement = document.getElementById('task-updated-info');
    if (updatedElement && data.updated_by) {
        // Находим span с временем обновления
        const updatedTimeSpan = updatedElement.querySelector('.utc-time');
        if (updatedTimeSpan && data.updated_at) {
            updatedTimeSpan.setAttribute('data-utc', data.updated_at);
            // Временно отображаем UTC время
            const utcDate = new Date(data.updated_at);
            const utcDateStr = utcDate.toISOString().slice(0, 16).replace('T', ' ');
            updatedTimeSpan.textContent = utcDateStr;
        }
        updatedElement.innerHTML = `${data.updated_by} в ${updatedTimeSpan ? updatedTimeSpan.outerHTML : ''}`;
    }
    
    // Обновляем время создания
    const createdElement = document.querySelector('[data-utc].utc-time');
    if (createdElement && data.created_at) {
        createdElement.setAttribute('data-utc', data.created_at);
        const utcDate = new Date(data.created_at);
        const utcDateStr = utcDate.toISOString().slice(0, 16).replace('T', ' ');
        createdElement.textContent = utcDateStr;
    }
    
    // Обновляем значения в форме редактирования
    const editTitle = document.getElementById('edit-title');
    if (editTitle) editTitle.value = data.title;
    
    const editStatus = document.getElementById('edit-status');
    if (editStatus) editStatus.value = data.status;
    
    const editPriority = document.getElementById('edit-priority');
    if (editPriority) editPriority.value = data.priority;
    
    // Обновляем поле дедлайна в форме
    const editDeadline = document.getElementById('edit-deadline');
    if (editDeadline && data.deadline) {
        try {
            const utcDate = new Date(data.deadline);
            const localDate = new Date(utcDate.getTime() - (utcDate.getTimezoneOffset() * 60000));
            editDeadline.value = localDate.toISOString().slice(0, 16);
        } catch (error) {
            console.error('Ошибка обновления дедлайна:', error);
            editDeadline.value = '';
        }
    } else if (editDeadline) {
        editDeadline.value = '';
    }
    
    const editDescription = document.getElementById('edit-description');
    if (editDescription) editDescription.value = data.description || '';
    
    const editTeam = document.getElementById('edit-team');
    if (editTeam && data.team) {
        editTeam.value = data.team.id;
    } else if (editTeam) {
        editTeam.value = '';
    }
    
    const editAssignee = document.getElementById('edit-assignee');
    if (editAssignee && data.assignee) {
        editAssignee.value = data.assignee.id;
    } else if (editAssignee) {
        editAssignee.value = '';
    }
    
    const editVisible = document.getElementById('edit-visible');
    if (editVisible) editVisible.checked = data.visible;
    
    // Обновляем исходные значения
    updateOriginalValues(data);
    
    // После обновления данных, снова конвертируем время в локальное
    setTimeout(convertAllTimes, 100);
}

// Обновление прав доступа на странице
function updatePermissions(data) {
    // Обновляем иконки прав
    document.getElementById('perm-content').textContent = data.can_edit_content ? '✅' : '❌';
    document.getElementById('perm-team').textContent = data.can_edit_team ? '✅' : '❌';
    document.getElementById('perm-assignee').textContent = data.can_edit_assignee ? '✅' : '❌';
    document.getElementById('perm-visibility').textContent = data.can_edit_visibility ? '✅' : '❌';
    
    // Обновляем чекбоксы в форме
    const permContentCheckbox = document.getElementById('perm-edit-content');
    if (permContentCheckbox) permContentCheckbox.checked = data.can_edit_content;
    
    const permTeamCheckbox = document.getElementById('perm-edit-team');
    if (permTeamCheckbox) permTeamCheckbox.checked = data.can_edit_team;
    
    const permAssigneeCheckbox = document.getElementById('perm-edit-assignee');
    if (permAssigneeCheckbox) permAssigneeCheckbox.checked = data.can_edit_assignee;
    
    const permVisibilityCheckbox = document.getElementById('perm-edit-visibility');
    if (permVisibilityCheckbox) permVisibilityCheckbox.checked = data.can_edit_visibility;
    
    // Обновляем исходные значения после изменения прав
    updatePermissionsOriginalValues();
}

// Обработка формы обновления задачи
document.addEventListener('DOMContentLoaded', function() {
    // При загрузке страницы конвертируем все времена из UTC в локальное
    convertAllTimes();
    
    // Инициализируем исходные значения прав доступа
    if (document.getElementById('update-permissions-form')) {
        updatePermissionsOriginalValues();
    }
    
    const updateTaskForm = document.getElementById('update-task-form');
    if (updateTaskForm) {
        updateTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Создаем FormData с базовыми данными
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', this.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('action', 'update_task');
            
            // Собираем только измененные поля, которые пользователь может редактировать
            const fields = [
                {id: 'edit-title', name: 'title', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-status', name: 'status', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-priority', name: 'priority', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-description', name: 'description', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-deadline', name: 'deadline', canEdit: {{ can_edit_content|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-team', name: 'team', canEdit: {{ can_edit_team|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
                {id: 'edit-assignee', name: 'assignee', canEdit: {{ can_edit_assignee|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }}},
            ];
            
            let hasChanges = false;
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    const currentValue = getFieldValue(element);
                    
                    // Для дедлайна обрабатываем отдельно
                    if (field.name === 'deadline') {
                        const originalUTC = document.getElementById('original-deadline-utc')?.value;
                        
                        // Нормализуем оригинальное значение для сравнения
                        let normalizedOriginal = '';
                        if (originalUTC && originalUTC.trim() !== '') {
                            try {
                                // Конвертируем ISO строку в формат YYYY-MM-DD HH:MM:SS
                                const utcDate = new Date(originalUTC);
                                const year = utcDate.getUTCFullYear();
                                const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(utcDate.getUTCDate()).padStart(2, '0');
                                const hours = String(utcDate.getUTCHours()).padStart(2, '0');
                                const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');
                                normalizedOriginal = `${year}-${month}-${day} ${hours}:${minutes}:00`;
                            } catch (error) {
                                console.error('Ошибка нормализации оригинального времени:', error);
                            }
                        }
                        
                        if (field.canEdit) {
                            // Если пользователь может редактировать
                            if (currentValue) {
                                // Преобразуем локальное время в UTC строку для отправки
                                const utcString = localDateTimeToUTC(localDateTimeToLocalString(currentValue));
                                
                                // Сравниваем с нормализованным оригиналом
                                if (utcString !== normalizedOriginal) {
                                    formData.append(field.name, utcString);
                                    hasChanges = true;
                                    console.log('Дедлайн изменился:', {
                                        старое: normalizedOriginal,
                                        новое: utcString
                                    });
                                } else {
                                    // Если значение не изменилось, отправляем оригинальное
                                    formData.append(field.name, originalUTC ? normalizedOriginal : '');
                                    console.log('Дедлайн не изменился');
                                }
                            } else if (originalUTC && originalUTC.trim() !== '' && currentValue === '') {
                                // Если дедлайн удален (пустая строка при наличии старого значения)
                                formData.append(field.name, '');
                                hasChanges = true;
                                console.log('Дедлайн удален');
                            } else if (!originalUTC && !currentValue) {
                                // Если дедлайна не было и не установлен - ничего не меняется
                                formData.append(field.name, '');
                                console.log('Дедлайн не был установлен и не установлен');
                            } else if (originalUTC && currentValue === '') {
                                // Дедлайн удален
                                formData.append(field.name, '');
                                hasChanges = true;
                                console.log('Дедлайн удален');
                            }
                        } else if (originalUTC && originalUTC.trim() !== '') {
                            // Если нельзя редактировать, отправляем оригинальное значение
                            formData.append(field.name, normalizedOriginal);
                            console.log('Дедлайн нельзя редактировать, отправляем оригинал');
                        }
                    } else {
                        // Для остальных полей
                        const originalElement = document.getElementById(`original-${field.name}`);
                        const originalValue = originalElement ? originalElement.value : '';
                        
                        // Если поле можно редактировать и значение изменилось
                        if (field.canEdit && currentValue !== originalValue) {
                            formData.append(field.name, currentValue);
                            hasChanges = true;
                            console.log(`Поле ${field.name} изменилось:`, {
                                старое: originalValue,
                                новое: currentValue
                            });
                        } else if (!field.canEdit && originalElement) {
                            // Если нельзя редактировать, отправляем исходное значение
                            formData.append(field.name, originalValue);
                        }
                    }
                }
            });
            
            // Обработка чекбокса видимости
            const visibleCheckbox = document.getElementById('edit-visible');
            if (visibleCheckbox) {
                const currentValue = visibleCheckbox.checked ? 'on' : 'off';
                const originalElement = document.getElementById('original-visible');
                const originalValue = originalElement ? originalElement.value : '';
                const canEditVisibility = {{ can_edit_visibility|yesno:"true,false" }} || {{ is_special_editor|yesno:"true,false" }};
                
                if (canEditVisibility && currentValue !== originalValue) {
                    formData.append('visible', currentValue);
                    hasChanges = true;
                } else if (!canEditVisibility && originalElement) {
                    formData.append('visible', originalValue);
                }
            }
            
            // Валидация только если есть изменения
            if (hasChanges) {
                // Проверяем название задачи (если оно изменялось)
                const titleElement = document.getElementById('edit-title');
                if (titleElement && titleElement.getAttribute('data-can-edit') === 'true') {
                    const titleValue = getFieldValue(titleElement);
                    if (!titleValue || titleValue.trim().length === 0) {
                        showMessage('Название задачи не может быть пустым', 'error');
                        return;
                    }
                }
                
                const messageElement = document.getElementById('update-task-message');
                messageElement.textContent = 'Сохранение...';
                messageElement.style.color = '#666';
                
                fetch('', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        messageElement.textContent = '✓ ' + data.message;
                        messageElement.style.color = 'green';
                        showMessage(data.message, 'success');
                        
                        // Обновляем информацию на странице
                        if (data.task_data) {
                            updateTaskInfo(data.task_data);
                        }
                    } else {
                        messageElement.textContent = '✗ Ошибка';
                        messageElement.style.color = 'red';
                        
                        if (data.errors && Array.isArray(data.errors)) {
                            data.errors.forEach(error => showMessage(error, 'error'));
                        } else if (data.error) {
                            showMessage(data.error, 'error');
                        }
                    }
                    
                    // Очищаем сообщение через 3 секунды
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageElement.textContent = '✗ Ошибка сети';
                    messageElement.style.color = 'red';
                    showMessage('Ошибка сети при сохранении: ' + error.message, 'error');
                    
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                });
            } else {
                showMessage('Нет изменений для сохранения', 'info');
            }
        });
    }
    
    // Обработка формы обновления прав доступа
    const updatePermissionsForm = document.getElementById('update-permissions-form');
    if (updatePermissionsForm) {
        updatePermissionsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Проверяем, были ли изменения
            if (!checkPermissionsChanges()) {
                showMessage('Нет изменений в настройках прав доступа для сохранения', 'info');
                return;
            }
            
            // Удаляем скрытые поля, если чекбокс отмечен
            const formData = new FormData(this);
            const checkboxes = ['can_edit_content', 'can_edit_team', 'can_edit_assignee', 'can_edit_visibility'];
            
            checkboxes.forEach(field => {
                if (formData.get(field) === 'on') {
                    // Удаляем скрытое поле, так как чекбокс отмечен
                    const hiddenField = this.querySelector(`input[type="hidden"][name="${field}"]`);
                    if (hiddenField) {
                        hiddenField.remove();
                    }
                }
            });
            
            const messageElement = document.getElementById('update-permissions-message');
            messageElement.textContent = 'Сохранение...';
            messageElement.style.color = '#666';
            
            fetch('', {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    messageElement.textContent = '✓ ' + data.message;
                    messageElement.style.color = 'green';
                    showMessage(data.message, 'success');
                    
                    // Обновляем права на странице
                    if (data.permissions) {
                        updatePermissions(data.permissions);
                    }
                } else {
                    messageElement.textContent = '✗ Ошибка';
                    messageElement.style.color = 'red';
                    showMessage(data.error, 'error');
                }
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.textContent = '✗ Ошибка сети';
                messageElement.style.color = 'red';
                showMessage('Ошибка сети при сохранении: ' + error.message, 'error');
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            });
        });
    }
    
    // Обработка формы удаления задачи
    const deleteTaskForm = document.getElementById('delete-task-form');
    if (deleteTaskForm) {
        deleteTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('Вы уверены, что хотите удалить задачу «{{ task.title }}»? Это действие нельзя отменить.')) {
                return;
            }
            
            const formData = new FormData(this);
            const messageElement = document.getElementById('delete-task-message');
            messageElement.textContent = 'Удаление...';
            messageElement.style.color = '#666';
            
            fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    messageElement.textContent = '✓ ' + data.message;
                    messageElement.style.color = 'green';
                    showMessage(data.message, 'success');
                    
                    // Перенаправляем через 2 секунды
                    setTimeout(() => {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        }
                    }, 2000);
                } else {
                    messageElement.textContent = '✗ Ошибка';
                    messageElement.style.color = 'red';
                    showMessage(data.error, 'error');
                    
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageElement.textContent = '✗ Ошибка сети';
                messageElement.style.color = 'red';
                showMessage('Ошибка сети при удалении: ' + error.message, 'error');
                
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            });
        });
    }
});
</script>

{% endblock %}