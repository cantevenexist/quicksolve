{% extends 'layout.html' %}
{% block content %}
<div style="display: flex; flex-direction: row; gap: 10px">
    <h1>{{ team.name }}</h1>
    {% if team_user_membership.user %}
    <button style="cursor: pointer; height: 40px; margin-top: 20px;">Покинуть</button>
    {% else %}
    <button style="cursor: pointer; height: 40px; margin-top: 20px;">Присоединиться</button>
    {% endif %}
    <!-- Кнопка управления -->
    <button onclick="openManagement()" style="cursor: pointer; height: 40px; margin-top: 20px;">{% if can_edit_team or can_manage_access %}Управление{% else %}Подробнее{% endif %}</button>
</div>

<!-- Количество участников -->
<div style="cursor: pointer; color: #666; margin-bottom: 20px;" onclick="openManagementWithMembers()">
    {% with total_members=team_members.count %}
        {{ total_members }} участник{{ total_members|pluralize:"ов" }}
    {% endwith %}
</div>

{% if can_create_tasks %}
    <a href="{% url 'workspace:task_create' team.workspace.url_hash %}?team={{ team.url_hash }}">Создать задачу для этой команды</a><br>
{% endif %}

<a href="{% url 'workspace:task_list' team.workspace.url_hash %}?team={{ team.url_hash }}">Показать все задачи команды</a>

<!-- Блок управления -->
<div id="managementBlock" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1000; width: 80%; max-width: 800px; max-height: 90%; overflow-y: scroll;">
    <div style="position: absolute; top: 10px; right: 10px; cursor: pointer;" onclick="closeManagement()">✕</div>
    
    <div style="display: flex;">
        <!-- Навигация -->
        <div style="width: 30%; border-right: 1px solid #ccc; padding-right: 20px;">
            <div id="navMain" style="cursor: pointer; padding: 10px; background: #f0f0f0;" onclick="showContent('main')">Главное</div>
            <div id="navMembers" style="cursor: pointer; padding: 10px;" onclick="showContent('members')">Участники</div>
            
            <!-- Администрирование - только для лидеров -->
            {% if team_user_membership.role == 'leader' or workspace_user_membership.role == 'owner' %}
            <div id="navAdmin" style="cursor: pointer; padding: 10px;" onclick="showContent('admin')">Администрирование</div>
            {% endif %}
            
            <!-- Управление доступом - только для тех, у кого есть права -->
            {% if can_manage_access %}
            <div id="navAccess" style="cursor: pointer; padding: 10px;" onclick="showContent('access')">Управление доступом</div>
            {% endif %}
        </div>
        
        <!-- Контент -->
        <div style="width: 70%; padding-left: 20px;">
            <!-- Главное - доступно всем, но редактирование только с правами -->
            <div id="contentMain" style="display: block;">
                <h3>Основные настройки</h3>
                
                {% if can_edit_team %}
                <form id="teamMainForm">
                    <div>
                        <label>Название:</label>
                        <input type="text" id="teamName" value="{{ team.name }}" style="width: 100%; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label>Описание:</label>
                        <textarea id="teamDescription" style="width: 100%; height: 100px; margin-bottom: 10px;">{{ team.description|default:'' }}</textarea>
                    </div>
                    <button type="button" onclick="saveTeamMainSettings()">Сохранить</button>
                </form>
                {% else %}
                <div>
                    <p><strong>Название:</strong> {{ team.name }}</p>
                    <p><strong>Описание:</strong> {{ team.description|default:"Не указано" }}</p>
                    <p style="color: #666; font-style: italic;">Для изменения настроек обратитесь к лидеру команды</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Участники -->
            <div id="contentMembers" style="display: none;">
                <h3>Участники команды</h3>
                
                <!-- Текущие участники -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Текущие участники</h4>
                        
                        <!-- Кнопка удаления - только для тех, у кого есть права -->
                        {% if can_manage_access %}
                        <div>
                            <button id="kickMembersBtn" type="button" onclick="toggleKickMode()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Удалить
                            </button>
                            <button id="cancelKickBtn" type="button" onclick="cancelKickMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div id="membersList">
                        {% for member in team_members %}
                            <div class="member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                <!-- Чекбоксы для удаления - только при наличии прав -->
                                {% if can_manage_access %}
                                <input type="checkbox" name="kick_user_ids" value="{{ member.user.id }}" 
                                       style="margin-right: 10px; display: none;" 
                                       class="kick-checkbox"
                                       {% if member.user == user or member.role == 'leader' %}disabled{% endif %}>
                                {% endif %}
                                <div style="flex: 1;">
                                    {{ member.user }} ({{ member.get_role_display }})
                                    {% if member.user == user %}<span style="color: #666;">(Вы)</span>{% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <li>Нет других участников</li>
                        {% endfor %}
                    </div>
                    
                    <!-- Блок действий удаления - только при наличии прав -->
                    {% if can_manage_access %}
                    <div id="kickActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmKickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Удалить выбранных
                        </button>
                        <span id="selectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Добавление участников - только для тех, у кого есть права -->
                {% if can_invite_users %}
                <div style="margin-bottom: 30px;">
                    <h4>Добавить участников из рабочей области</h4>
                    
                    <!-- Сообщения о результате -->
                    <div id="inviteResult" style="display: none; margin-bottom: 10px; padding: 10px; border-radius: 4px;"></div>
                    
                    <!-- Список пользователей рабочей области -->
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
                        {% for workspace_member in workspace_members %}
                            <div>
                                <label style="display: block; padding: 5px;">
                                    <input type="checkbox" name="user_ids" value="{{ workspace_member.user.id }}" style="margin-right: 8px;">
                                    {{ workspace_member.user.username }}
                                </label>
                            </div>
                        {% empty %}
                            <p>Нет доступных пользователей для добавления</p>
                        {% endfor %}
                    </div>
                    
                    <button type="button" onclick="addSelectedUsers()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Добавить выбранных пользователей
                    </button>
                </div>
                {% else %}
                <!-- Сообщение для пользователей без прав приглашения -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                    <p style="color: #666; margin: 0;">У вас нет прав для приглашения новых участников</p>
                </div>
                {% endif %}
            </div>

            <!-- Модальное окно подтверждения удаления -->
            <div id="confirmKickModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0;">Подтверждение удаления</h3>
                <p id="confirmKickMessage">Вы уверены, что хотите удалить выбранных пользователей из команды?</p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" onclick="closeConfirmKickModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Отмена
                    </button>
                    <button type="button" onclick="kickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Удалить
                    </button>
                </div>
            </div>

            <!-- Администрирование - только для лидеров -->
            {% if team_user_membership.role == 'leader' or workspace_user_membership.role == 'owner' %}
            <div id="contentAdmin" style="display: none;">
                <h3>Администраторы команды</h3>
                
                <!-- Назначение администраторов -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Назначить администраторов</h4>
                        <div>
                            <button id="promoteMembersBtn" type="button" onclick="togglePromoteMode()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Назначить
                            </button>
                            <button id="cancelPromoteBtn" type="button" onclick="cancelPromoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="promoteMembersList">
                        {% for member in members_for_promotion %}
                            <div class="promote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                <input type="checkbox" name="promote_user_ids" value="{{ member.user.id }}" 
                                       style="margin-right: 10px; display: none;" 
                                       class="promote-checkbox"
                                       data-username="{{ member.user.username }}">
                                <div style="flex: 1;">
                                    {{ member.user }} ({{ member.get_role_display }})
                                </div>
                            </div>
                        {% empty %}
                            <ul><li>Нет обычных участников</li></ul>
                        {% endfor %}
                    </div>
                    
                    <div id="promoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmPromoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назначить выбранных
                        </button>
                        <span id="promoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>

                <!-- Разжалование администраторов -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Разжаловать администраторов</h4>
                        <div>
                            <button id="demoteMembersBtn" type="button" onclick="toggleDemoteMode()" style="padding: 6px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Разжаловать
                            </button>
                            <button id="cancelDemoteBtn" type="button" onclick="cancelDemoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="demoteMembersList">
                        {% for member in members_for_demotion %}
                            <div class="demote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                <input type="checkbox" name="demote_user_ids" value="{{ member.user.id }}" 
                                       style="margin-right: 10px; display: none;" 
                                       class="demote-checkbox"
                                       data-username="{{ member.user.username }}">
                                <div style="flex: 1;">
                                    {{ member.user }} ({{ member.get_role_display }})
                                </div>
                            </div>
                        {% empty %}
                            <ul><li>Нет администраторов</li></ul>
                        {% endfor %}
                    </div>
                    
                    <div id="demoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmDemoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                            Разжаловать выбранных
                        </button>
                        <span id="demoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Управление доступом - только для тех, у кого есть права -->
            {% if can_manage_access %}
            <div id="contentAccess" style="display: none;">
                <h3>Управление доступом команды</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Настройте права доступа для различных ролей в команде
                </p>

                <!-- Настройки прав команды -->
                <div style="margin-bottom: 30px;">
                    <h4>Права команды</h4>
                    
                    <form id="teamAccessForm">
                        {% csrf_token %}
                        {% if team_user_membership.role == 'leader' or workspace_user_membership.role == 'owner' %}
                        <!-- Управление доступом -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Управление доступом</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может управлять доступом к команде (назначать права, массово приглашать и удалять пользователей)
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="leader" checked disabled>
                                    Лидер
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Редактирование команды -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Редактирование команды</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может изменять настройки команды
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_team" value="leader" checked disabled>
                                    Лидер
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_team" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_team" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Приглашение пользователей -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Приглашение пользователей</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может приглашать новых пользователей в команду
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="leader" checked disabled>
                                    Лидер
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Видимость команды -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Видимость команды</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может видеть команду, если не состоит в ней
                            </p>
                            <div class="visibility-options">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="radio" name="visibility" value="private">
                                    Только для участников команды
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="radio" name="visibility" value="workspace">
                                    Для всех участников рабочей области
                                </label>
                            </div>
                            <p style="color: #999; font-size: 12px; margin-top: 5px;">
                                <strong>Примечание:</strong> Владельцы и администраторы рабочей области всегда видят все команды
                            </p>
                        </div>

                        <button type="button" onclick="saveTeamAccessSettings()" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px;">
                            Сохранить настройки доступа
                        </button>
                    </form>

                    <div id="teamAccessResult" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальные окна для административных действий -->
{% if team_user_membership.role == 'leader' or workspace_user_membership.role == 'owner' %}
<!-- Модальное окно подтверждения назначения -->
<div id="confirmPromoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение назначения</h3>
    <p id="confirmPromoteMessage">Вы уверены, что хотите назначить выбранных пользователей администраторами команды?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmPromoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="promoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Назначить
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения разжалования -->
<div id="confirmDemoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение разжалования</h3>
    <p id="confirmDemoteMessage">Вы уверены, что хотите разжаловать выбранных администраторов команды?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmDemoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="demoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            Разжаловать
        </button>
    </div>
</div>
{% endif %}

<br>
<a href="{% url 'workspace:workspace_detail' team.workspace.url_hash %}">Назад к рабочей области</a>

<script>
// Добавляем функцию для сохранения основных настроек команды
function saveTeamMainSettings() {
    const name = document.getElementById('teamName').value;
    const description = document.getElementById('teamDescription').value;
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Нужно создать соответствующий URL в urls.py и view
    fetch(`{% url 'workspace:workspace_index' %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Настройки команды успешно сохранены');
            location.reload();
        } else {
            alert('Ошибка при сохранении: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении настроек команды');
    });
}

// Управление модальным окном
function openManagement() {
    document.getElementById('managementBlock').style.display = 'block';
}

function closeManagement() {
    document.getElementById('managementBlock').style.display = 'none';
}

function openManagementWithMembers() {
    document.getElementById('managementBlock').style.display = 'block';
    showContent('members');
}

function showContent(section) {
    document.querySelectorAll('[id^="content"]').forEach(el => el.style.display = 'none');
    document.querySelectorAll('[id^="nav"]').forEach(el => el.style.background = '');
    
    const contentElement = document.getElementById(`content${section.charAt(0).toUpperCase() + section.slice(1)}`);
    contentElement.style.display = 'block';
    document.getElementById(`nav${section.charAt(0).toUpperCase() + section.slice(1)}`).style.background = '#f0f0f0';
    
    if (section === 'access') {
        // Загружаем настройки при открытии вкладки доступа
        loadTeamAccessSettings();
    }
}

// Функция для загрузки настроек доступа команды через AJAX
function loadTeamAccessSettings() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:get_team_access_settings' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateTeamCheckboxState(data.access_data);
        } else {
            console.error('Error loading team access settings:', data.error);
            document.getElementById('teamAccessResult').innerHTML = 
                '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка загрузки настроек доступа команды</div>';
            document.getElementById('teamAccessResult').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('teamAccessResult').innerHTML = 
            '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при загрузке настроек команды</div>';
        document.getElementById('teamAccessResult').style.display = 'block';
    });
}

// Функция для обновления состояния чекбоксов команды на основе данных
function updateTeamCheckboxState(settings) {
    const permissions = [
        'can_manage_access',
        'can_edit_team',
        'can_invite_users'
    ];
    
    permissions.forEach(permission => {
        const roles = settings[permission] || [];
        const checkboxes = document.querySelectorAll(`input[name="${permission}"]`);
        
        checkboxes.forEach(checkbox => {
            if (checkbox.value === 'leader') {
                // Лидер всегда отмечен и заблокирован
                checkbox.checked = true;
                checkbox.disabled = true;
            } else {
                // Для других ролей устанавливаем состояние из загруженных данных
                checkbox.checked = roles.includes(checkbox.value);
                checkbox.disabled = false;
            }
        });
    });
    
    // Обновляем радиокнопки видимости
    const visibility = settings.visibility || 'private';
    const visibilityRadios = document.querySelectorAll('input[name="visibility"]');
    visibilityRadios.forEach(radio => {
        radio.checked = (radio.value === visibility);
    });
}

// Сохранение настроек доступа команды
function saveTeamAccessSettings() {
    const form = document.getElementById('teamAccessForm');
    const formData = new FormData();
    
    // Собираем данные из чекбоксов
    const permissions = [
        {% if team_user_membership.role == 'leader' or workspace_user_membership.role == 'owner' %}'can_manage_access',{% endif %}
        'can_edit_team',
        'can_invite_users'
    ];
    
    permissions.forEach(permission => {
        const checkboxes = form.querySelectorAll(`input[name="${permission}"]:checked`);
        const values = Array.from(checkboxes).map(cb => cb.value);
        formData.append(permission, JSON.stringify(values));
    });
    
    // Добавляем настройку видимости
    const visibility = form.querySelector('input[name="visibility"]:checked');
    if (visibility) {
        formData.append('visibility', visibility.value);
    }
    
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:save_team_access_settings' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('teamAccessResult');
        
        if (data.success) {
            resultDiv.innerHTML = '<div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Настройки доступа команды успешно сохранены</div>';
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.error || 'Неизвестная ошибка'}</div>`;
        }
        
        resultDiv.style.display = 'block';
        setTimeout(() => resultDiv.style.display = 'none', 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('teamAccessResult').innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при сохранении настроек</div>';
        document.getElementById('teamAccessResult').style.display = 'block';
    });
}

// Удалите старые функции, которые использовали данные из контекста
// function updateTeamAccessCheckboxes() {
//     // Больше не используем данные из контекста
//     loadTeamAccessSettings();
// }

// Остальной JavaScript код остается без изменений...
// [Остальной JavaScript код из вашего шаблона остается здесь без изменений]

// Функция для добавления выбранных пользователей
function addSelectedUsers() {
    const selectedUsers = document.querySelectorAll('input[name="user_ids"]:checked');
    const userIds = Array.from(selectedUsers).map(input => input.value);
    
    if (userIds.length === 0) {
        showInviteResult('Пожалуйста, выберите хотя бы одного пользователя', 'error');
        return;
    }
    
    const formData = new FormData();
    userIds.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    
    // Добавляем CSRF токен как в примере
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:team_invite_members' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно добавлено пользователей: ${data.added_count}`;
            if (data.added_users && data.added_users.length > 0) {
                const userNames = data.added_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            showInviteResult(successMessage, 'success');
            
            // Обновляем список текущих участников (можно перезагрузить страницу или обновить динамически)
            setTimeout(() => {
                location.reload(); // Простой способ обновить данные
            }, 2000);
            
        } else {
            showInviteResult(`Ошибка: ${data.error}`, 'error');
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('<br>');
            showInviteResult(`Ошибки:<br>${errorMessage}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showInviteResult('Произошла ошибка при отправке запроса', 'error');
    });
}

// Функция для показа результатов приглашения
function showInviteResult(message, type) {
    const resultDiv = document.getElementById('inviteResult');
    resultDiv.innerHTML = message;
    resultDiv.style.display = 'block';
    
    if (type === 'success') {
        resultDiv.style.background = '#d4edda';
        resultDiv.style.color = '#155724';
        resultDiv.style.border = '1px solid #c3e6cb';
    } else {
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.style.border = '1px solid #f5c6cb';
    }
}

// Переменные для управления удалением
let kickMode = false;
let selectedUsersToKick = [];

// Включение/выключение режима удаления
function toggleKickMode() {
    kickMode = !kickMode;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    const kickBtn = document.getElementById('kickMembersBtn');
    const cancelBtn = document.getElementById('cancelKickBtn');
    const kickActions = document.getElementById('kickActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = kickMode ? 'block' : 'none';
    });
    
    kickBtn.style.display = kickMode ? 'none' : 'block';
    cancelBtn.style.display = kickMode ? 'block' : 'none';
    kickActions.style.display = kickMode ? 'block' : 'none';
    
    if (!kickMode) {
        selectedUsersToKick = [];
        updateSelectedCount();
    }
}

function cancelKickMode() {
    kickMode = false;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('kickMembersBtn').style.display = 'block';
    document.getElementById('cancelKickBtn').style.display = 'none';
    document.getElementById('kickActions').style.display = 'none';
    
    selectedUsersToKick = [];
    updateSelectedCount();
}

// Обновление счетчика выбранных пользователей
function updateSelectedCount() {
    const selectedCount = document.getElementById('selectedCount');
    const count = selectedUsersToKick.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('kick-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToKick.includes(userId)) {
                selectedUsersToKick.push(userId);
            }
        } else {
            const index = selectedUsersToKick.indexOf(userId);
            if (index > -1) {
                selectedUsersToKick.splice(index, 1);
            }
        }
        
        updateSelectedCount();
    }
});

// Подтверждение удаления
function confirmKickMembers() {
    if (selectedUsersToKick.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для удаления');
        return;
    }
    
    const confirmModal = document.getElementById('confirmKickModal');
    const message = document.getElementById('confirmKickMessage');
    
    if (selectedUsersToKick.length === 1) {
        message.textContent = 'Вы уверены, что хотите удалить выбранного пользователя из команды?';
    } else {
        message.textContent = `Вы уверены, что хотите удалить ${selectedUsersToKick.length} пользователей из команды?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmKickModal() {
    document.getElementById('confirmKickModal').style.display = 'none';
}

// Удаление пользователей
function kickMembers() {
    const formData = new FormData();
    selectedUsersToKick.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:team_kick_members' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmKickModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно удалено пользователей: ${data.removed_count}`;
            if (data.removed_users && data.removed_users.length > 0) {
                const userNames = data.removed_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            showKickResult(successMessage, 'success');
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 2000);
            
        } else {
            showKickResult(`Ошибка: ${data.error}`, 'error');
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('<br>');
            showKickResult(`Ошибки:<br>${errorMessage}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showKickResult('Произошла ошибка при отправке запроса', 'error');
    });
}

// Функция для показа результатов удаления
function showKickResult(message, type) {
    // Можно использовать тот же контейнер или создать новый
    const resultDiv = document.getElementById('inviteResult');
    resultDiv.innerHTML = message;
    resultDiv.style.display = 'block';
    
    if (type === 'success') {
        resultDiv.style.background = '#d4edda';
        resultDiv.style.color = '#155724';
        resultDiv.style.border = '1px solid #c3e6cb';
    } else {
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.style.border = '1px solid #f5c6cb';
    }
}

// Функционал управления ролями
let promoteMode = false;
let demoteMode = false;
let selectedUsersToPromote = [];
let selectedUsersToDemote = [];

// Назначение администраторов
function togglePromoteMode() {
    promoteMode = !promoteMode;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    const promoteBtn = document.getElementById('promoteMembersBtn');
    const cancelBtn = document.getElementById('cancelPromoteBtn');
    const promoteActions = document.getElementById('promoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = promoteMode ? 'block' : 'none';
    });
    
    promoteBtn.style.display = promoteMode ? 'none' : 'block';
    cancelBtn.style.display = promoteMode ? 'block' : 'none';
    promoteActions.style.display = promoteMode ? 'block' : 'none';
    
    if (!promoteMode) {
        selectedUsersToPromote = [];
        updatePromoteSelectedCount();
    }
}

function cancelPromoteMode() {
    promoteMode = false;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('promoteMembersBtn').style.display = 'block';
    document.getElementById('cancelPromoteBtn').style.display = 'none';
    document.getElementById('promoteActions').style.display = 'none';
    
    selectedUsersToPromote = [];
    updatePromoteSelectedCount();
}

function updatePromoteSelectedCount() {
    const selectedCount = document.getElementById('promoteSelectedCount');
    const count = selectedUsersToPromote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Разжалование администраторов
function toggleDemoteMode() {
    demoteMode = !demoteMode;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    const demoteBtn = document.getElementById('demoteMembersBtn');
    const cancelBtn = document.getElementById('cancelDemoteBtn');
    const demoteActions = document.getElementById('demoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = demoteMode ? 'block' : 'none';
    });
    
    demoteBtn.style.display = demoteMode ? 'none' : 'block';
    cancelBtn.style.display = demoteMode ? 'block' : 'none';
    demoteActions.style.display = demoteMode ? 'block' : 'none';
    
    if (!demoteMode) {
        selectedUsersToDemote = [];
        updateDemoteSelectedCount();
    }
}

function cancelDemoteMode() {
    demoteMode = false;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('demoteMembersBtn').style.display = 'block';
    document.getElementById('cancelDemoteBtn').style.display = 'none';
    document.getElementById('demoteActions').style.display = 'none';
    
    selectedUsersToDemote = [];
    updateDemoteSelectedCount();
}

function updateDemoteSelectedCount() {
    const selectedCount = document.getElementById('demoteSelectedCount');
    const count = selectedUsersToDemote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов для назначения
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('promote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToPromote.includes(userId)) {
                selectedUsersToPromote.push(userId);
            }
        } else {
            const index = selectedUsersToPromote.indexOf(userId);
            if (index > -1) {
                selectedUsersToPromote.splice(index, 1);
            }
        }
        
        updatePromoteSelectedCount();
    }
});

// Обработка выбора чекбоксов для разжалования
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('demote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToDemote.includes(userId)) {
                selectedUsersToDemote.push(userId);
            }
        } else {
            const index = selectedUsersToDemote.indexOf(userId);
            if (index > -1) {
                selectedUsersToDemote.splice(index, 1);
            }
        }
        
        updateDemoteSelectedCount();
    }
});

// Подтверждение назначения
function confirmPromoteMembers() {
    if (selectedUsersToPromote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для назначения');
        return;
    }
    
    const confirmModal = document.getElementById('confirmPromoteModal');
    const message = document.getElementById('confirmPromoteMessage');
    
    if (selectedUsersToPromote.length === 1) {
        message.textContent = 'Вы уверены, что хотите назначить выбранного пользователя администратором команды?';
    } else {
        message.textContent = `Вы уверены, что хотите назначить ${selectedUsersToPromote.length} пользователей администраторами команды?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmPromoteModal() {
    document.getElementById('confirmPromoteModal').style.display = 'none';
}

// Подтверждение разжалования
function confirmDemoteMembers() {
    if (selectedUsersToDemote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного администратора для разжалования');
        return;
    }
    
    const confirmModal = document.getElementById('confirmDemoteModal');
    const message = document.getElementById('confirmDemoteMessage');
    
    if (selectedUsersToDemote.length === 1) {
        message.textContent = 'Вы уверены, что хотите разжаловать выбранного администратора команды?';
    } else {
        message.textContent = `Вы уверены, что хотите разжаловать ${selectedUsersToDemote.length} администраторов команды?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmDemoteModal() {
    document.getElementById('confirmDemoteModal').style.display = 'none';
}

// Назначение администраторов
function promoteMembers() {
    const formData = new FormData();
    selectedUsersToPromote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'promote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:team_change_member_role' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmPromoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно назначено администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

// Разжалование администраторов
function demoteMembers() {
    const formData = new FormData();
    selectedUsersToDemote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'demote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:team_change_member_role' team.workspace.url_hash team.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmDemoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно разжаловано администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}
</script>

{% endblock %}