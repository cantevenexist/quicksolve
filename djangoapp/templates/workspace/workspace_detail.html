{% extends 'layout.html' %}
{% block content %}

<div style="display: flex; flex-direction: row; gap: 10px">
    <h1>{{ workspace.name }}</h1>

    <!-- Кнопка управления - показываем только если есть права на редактирование -->
    {% if can_edit_workspace or can_manage_access %}
    <button onclick="openManagement()" style="cursor: pointer; height: 40px; margin-top: 20px;">Управление</button>
    {% endif %}
</div>

<!-- Количество участников -->
<div style="cursor: pointer; color: #666; margin-bottom: 20px;" 
    onclick="openManagementWithMembers()">
    {% with total_members=workspace.members.count %}
        {{ total_members }} участник{{ total_members|pluralize:"ов" }}
    {% endwith %}
</div>

<!-- Команды -->
<h2>Команды:</h2>
{% if can_create_teams %}
<a href="{% url 'workspace:team_create' workspace.url_hash %}">Создать команду</a>
{% endif %}

{% if teams %}
    <ul>
    {% for team in teams %}
        <li>
            <a href="{% url 'workspace:team_detail' workspace.url_hash team.url_hash %}">
                {{ team.name }}
            </a>
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>Нет команд</p>
{% endif %}

<!-- Задачи -->
<h2>Задачи:</h2>
{% if can_create_tasks %}
<a href="{% url 'workspace:task_create' workspace.url_hash %}">Создать задачу</a>
{% endif %}
<a href="{% url 'workspace:task_list' workspace.url_hash %}">Все задачи</a>

<!-- Блок управления -->
<div id="managementBlock" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1000; width: 80%; max-width: 800px; max-height: calc(90% - 100px); overflow-y: scroll;">
    <div style="position: absolute; top: 10px; right: 10px; cursor: pointer;" onclick="closeManagement()">✕</div>
    
    <div style="display: flex;">
        <!-- Навигация -->
        <div style="width: 30%; border-right: 1px solid #ccc; padding-right: 20px;">
            <div id="navMain" style="cursor: pointer; padding: 10px; background: #f0f0f0;" onclick="showContent('main')">Главное</div>
            <div id="navMembers" style="cursor: pointer; padding: 10px;" onclick="showContent('members')">Участники</div>
            
            <!-- Администрирование - только для владельца -->
            {% if workspace_user_membership.role == 'owner' %}
            <div id="navAdmin" style="cursor: pointer; padding: 10px;" onclick="showContent('admin')">Администрирование</div>
            {% endif %}
            
            <!-- Управление доступом - только для тех, у кого есть права -->
            {% if can_manage_access %}
            <div id="navAccess" style="cursor: pointer; padding: 10px;" onclick="showContent('access')">Управление доступом</div>
            {% endif %}
        </div>
        
        <!-- Контент -->
        <div style="width: 70%; padding-left: 20px;">
            <!-- Главное - доступно всем, но редактирование только с правами -->
            <!-- <div id="contentMain" style="display: block;">
                <h3>Основные настройки</h3>
                
                {% if can_edit_workspace %}
                <form id="workspaceMainForm">
                    <div>
                        <label>Название:</label>
                        <input type="text" id="workspaceName" value="{{ workspace.name }}" style="width: 100%; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label>Описание:</label>
                        <textarea id="workspaceDescription" style="width: 100%; height: 100px; margin-bottom: 10px;">{{ workspace.description|default:'' }}</textarea>
                    </div>
                    <button type="button" onclick="saveWorkspaceMainSettings()">Сохранить</button>
                </form>
                {% else %}
                <div>
                    <p><strong>Название:</strong> {{ workspace.name }}</p>
                    <p><strong>Описание:</strong> {{ workspace.description|default:"Не указано" }}</p>
                    <p style="color: #666; font-style: italic;">Для изменения настроек обратитесь к администратору рабочей области</p>
                </div>
                {% endif %}
            </div> -->
            
            <!-- Блок настроек рабочей области (например, в модальном окне или отдельной вкладке) -->
            <div id="contentMain" style="display: block">
                <h3>Основные настройки</h3>
                
                {% if can_edit_workspace %}
                <div id="workspaceMainFormContainer">
                    <form id="workspaceMainForm" onsubmit="event.preventDefault(); saveWorkspaceMainSettings();">
                        <div style="margin-bottom: 20px;">
                            <label for="workspaceName" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                Название рабочей области:
                            </label>
                            <input type="text" 
                                id="workspaceName" 
                                value="{{ workspace.name }}" 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px;"
                                placeholder="Введите название рабочей области"
                                maxlength="255"
                                required>
                            <!-- <p style="color: #666; font-size: 13px; margin-top: 5px;">
                                Минимум 2 символа, максимум 100 символов
                            </p> -->
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <label for="workspaceDescription" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                Описание рабочей области:
                            </label>
                            <textarea id="workspaceDescription" 
                                    style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; resize: vertical;"
                                    placeholder="Опишите цели и задачи рабочей области (необязательно)"
                                    maxlength="255">{{ workspace.description|default:'' }}</textarea>
                            <p style="color: #666; font-size: 13px; margin-top: 5px;">
                                Необязательное поле для дополнительной информации о рабочей области
                            </p>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-start; gap: 10px; margin-top: 25px;">
                            <button type="submit" 
                                    id="saveWorkspaceSettingsBtn"
                                    style="background: #28a745; color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; min-width: 120px;">
                                Сохранить изменения
                            </button>
                            <button type="button" 
                                    onclick="resetWorkspaceForm()"
                                    style="background: #6c757d; color: white; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 120px;">
                                Отмена
                            </button>
                        </div>
                    </form>
                    
                    <div id="workspaceEditResult" style="margin-top: 15px; display: none;"></div>
                </div>
                {% else %}
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #e0e0e0;">
                    <div style="margin-bottom: 15px;">
                        <p style="margin: 0 0 10px 0; font-weight: bold; color: #333;">
                            <strong>Название рабочей области:</strong>
                        </p>
                        <p style="margin: 0; padding: 10px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                            {{ workspace.name }}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; font-weight: bold; color: #333;">
                            <strong>Описание рабочей области:</strong>
                        </p>
                        <div style="padding: 10px; background: white; border-radius: 4px; border: 1px solid #e0e0e0; min-height: 80px;">
                            {% if workspace.description %}
                                {{ workspace.description|linebreaksbr }}
                            {% else %}
                                <span style="color: #999; font-style: italic;">Описание не указано</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 12px; margin-top: 20px;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            <strong>⚠️ Информация:</strong> Только владелец рабочей области может изменять основные настройки
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Участники -->
            <div id="contentMembers" style="display: none;">
                <h3>Участники рабочей области</h3>
                
                <!-- Текущие участники -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Текущие участники</h4>
                        
                        <!-- Кнопка удаления - только для тех, у кого есть права -->
                        {% if can_manage_access %}
                        <div>
                            <button id="kickMembersBtn" type="button" onclick="toggleKickMode()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Удалить
                            </button>
                            <button id="cancelKickBtn" type="button" onclick="cancelKickMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div id="membersList">
                        {% for member in members %}
                            <div class="member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                <!-- Чекбоксы для удаления - только при наличии прав -->
                                {% if can_manage_access %}
                                <input type="checkbox" name="kick_user_ids" value="{{ member.user.id }}" 
                                       style="margin-right: 10px; display: none;" 
                                       class="kick-checkbox"
                                       {% if member.user == user or member.role == 'owner' %}disabled{% endif %}>
                                {% endif %}
                                <div style="flex: 1;">
                                    {{ member.user }} ({{ member.get_role_display }})
                                    {% if member.user == user %}<span style="color: #666;">(Вы)</span>{% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <li>Нет других участников</li>
                        {% endfor %}
                    </div>
                    
                    <!-- Блок действий удаления - только при наличии прав -->
                    {% if can_manage_access %}
                    <div id="kickActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmKickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Удалить выбранных
                        </button>
                        <span id="selectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Массовое приглашение - только для тех, у кого есть права -->
                {% if can_manage_access %}
                <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <h4>Массовое приглашение</h4>
                    
                    {% if mass_invitation_url %}
                    <div id="existingMassInvitation" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef;">
                        <p style="margin: 0 0 10px 0; font-weight: bold;">
                            {% if mass_invitation_data.can_be_used %}Текущая активная ссылка:{% else %}Текущая ссылка (неактивна):{% endif %}
                        </p>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="existingInvitationLink" value="{{ mass_invitation_url }}" readonly 
                                   style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff;">
                            <button type="button" onclick="copyExistingInvitationLink()" 
                                    style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                Копировать
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <div>Срок действия: {{ mass_invitation_data.expiration_time }}</div>
                            <div>Использований: {{ mass_invitation_data.max_uses }} (текущее: {{ mass_invitation_data.current_uses }})</div>
                            <div>Статус: 
                                <span class="status-indicator" data-status="{% if mass_invitation_data.can_be_used %}active{% else %}inactive{% endif %}">
                                    {% if mass_invitation_data.can_be_used %}Активно{% else %}Неактивно{% endif %}
                                </span>
                                <style>
                                .status-indicator[data-status="active"] { color: #28a745; }
                                .status-indicator[data-status="inactive"] { color: #dc3545; }
                                </style>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <form id="massInvitationForm">
                        {% csrf_token %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Срок действия:</label>
                            <select name="expiration_time" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Бессрочно</option>
                                <option value="3600">1 час</option>
                                <option value="14400">4 часа</option>
                                <option value="86400">24 часа</option>
                                <option value="172800">48 часов</option>
                                <option value="259200">72 часа</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Количество использований:</label>
                            <input type="number" name="max_uses" min="1" placeholder="Оставьте пустым для безграничного использования"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <button type="button" onclick="createMassInvitation()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            {% if mass_invitation_url %}Обновить ссылку{% else %}Создать ссылку{% endif %}
                        </button>
                    </form>
                    
                    <div id="massInvitationResult" style="margin-top: 15px; display: none;"></div>
                </div>

                <!-- Управление приглашениями -->
                <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa;">
                    <h4>Управление приглашениями</h4>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span>Статус массового приглашения:</span>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="toggleAllInvitations" {% if mass_invitation_data.is_active %}checked{% endif %} onchange="toggleAllInvitations()" style="margin-right: 8px;">
                            <span>{% if mass_invitation_data.is_active %}Активно{% else %}Неактивно{% endif %}</span>
                        </label>
                    </div>
                </div>
                {% endif %}

                {% if can_invite_users %}
                <!-- Точечное приглашение -->
                <div style="margin-top: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <h4>Точечное приглашение</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Введите почты или уникальные коды через пробел или Enter
                    </p>
                    
                    <form id="individualInvitationForm">
                        {% csrf_token %}
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Почты или коды:</label>
                            <input type="text" id="identifiersInput" 
                                   placeholder="user1@example.com ABC123 user2@example.com"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            
                            <div id="identifiersList" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                        </div>
                        
                        <button type="button" onclick="createIndividualInvitations()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            Отправить приглашения
                        </button>
                    </form>
                    
                    <div id="individualInvitationResult" style="margin-top: 15px; display: none;"></div>
                </div>
                {% endif %}
                {% if not can_invite_users and not can_manage_access %}
                <!-- Сообщение для пользователей без прав приглашения -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; text-align: center;">
                    <p style="color: #666; margin: 0;">У вас нет прав для приглашения новых участников</p>
                </div>
                {% endif %}
            </div>

            <!-- Модальное окно подтверждения удаления -->
            <div id="confirmKickModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="margin-top: 0;">Подтверждение удаления</h3>
                <p id="confirmKickMessage">Вы уверены, что хотите удалить выбранных пользователей из рабочей области?</p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" onclick="closeConfirmKickModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Отмена
                    </button>
                    <button type="button" onclick="kickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Удалить
                    </button>
                </div>
            </div>

            <!-- Администрирование - только для владельца -->
            {% if workspace_user_membership.role == 'owner' %}
            <div id="contentAdmin" style="display: none;">
                <h3>Администраторы</h3>
                
                <!-- Назначение администраторов -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Назначить администраторов</h4>
                        <div>
                            <button id="promoteMembersBtn" type="button" onclick="togglePromoteMode()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Назначить
                            </button>
                            <button id="cancelPromoteBtn" type="button" onclick="cancelPromoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="promoteMembersList">
                        {% for member in members %}
                            {% if member.role == 'member' %}
                                <div class="promote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                    <input type="checkbox" name="promote_user_ids" value="{{ member.user.id }}" 
                                           style="margin-right: 10px; display: none;" 
                                           class="promote-checkbox"
                                           data-username="{{ member.user.username }}">
                                    <div style="flex: 1;">
                                        {{ member.user }} ({{ member.get_role_display }})
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <li>Нет обычных участников</li>
                        {% endfor %}
                    </div>
                    
                    <div id="promoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmPromoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назначить выбранных
                        </button>
                        <span id="promoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>

                <!-- Разжалование администраторов -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Разжаловать администраторов</h4>
                        <div>
                            <button id="demoteMembersBtn" type="button" onclick="toggleDemoteMode()" style="padding: 6px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Разжаловать
                            </button>
                            <button id="cancelDemoteBtn" type="button" onclick="cancelDemoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="demoteMembersList">
                        {% for member in members %}
                            {% if member.role == 'admin' %}
                                <div class="demote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                    <input type="checkbox" name="demote_user_ids" value="{{ member.user.id }}" 
                                           style="margin-right: 10px; display: none;" 
                                           class="demote-checkbox"
                                           data-username="{{ member.user.username }}">
                                    <div style="flex: 1;">
                                        {{ member.user }} ({{ member.get_role_display }})
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <li>Нет администраторов</li>
                        {% endfor %}
                    </div>
                    
                    <div id="demoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmDemoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                            Разжаловать выбранных
                        </button>
                        <span id="demoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>

                <!-- Передача владельца рабочей области -->
                <div style="margin-bottom: 30px; border-top: 2px solid #eee; padding-top: 30px;">
                    <h4 style="margin-bottom: 20px; color: #dc3545; font-size: 18px;">Передача роли владельца</h4>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404; font-weight: bold;">
                            ⚠️ Внимание:<br>Вы собираетесь передать роль владельца рабочей области другому участнику
                        </p>
                        <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">
                            После передачи вы станете администратором рабочей области и не сможете отменить это действие самостоятельно
                        </p>
                    </div>
                    
                    <form id="transferOwnerForm" style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
                        <div style="margin-bottom: 15px;">
                            <label for="newOwnerSelect" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                Выберите нового владельца рабочей области:
                            </label>
                            <select id="newOwnerSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white; font-size: 14px;">
                                <option value="" style="color: #999;">-- Выберите участника --</option>
                                {% for member in members %}
                                    {% if member.user != user and member.role != 'owner' %}
                                    <option value="{{ member.user.id }}" style="padding: 5px;">
                                        {{ member.user }} ({{ member.get_role_display }})
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="ownerPasswordConfirm" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                Подтвердите действие вашим паролем:
                            </label>
                            <input type="password" 
                                id="ownerPasswordConfirm" 
                                placeholder="Введите ваш пароль"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                autocomplete="current-password">
                            <p style="color: #666; font-size: 13px; margin-top: 5px;">
                                Для передачи роли владельца необходимо подтвердить вашу личность
                            </p>
                        </div>
                        
                        <button type="button" 
                                onclick="confirmOwnerTransfer()"
                                style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px;">
                            Передать роль владельца
                        </button>
                    </form>
                    
                    <div id="ownerTransferResult" style="margin-top: 15px; display: none;"></div>
                </div>

                <!-- Удаление рабочей области -->
                <div style="margin-top: 50px; padding-top: 30px; border-top: 3px solid #dc3545;">
                    <h4 style="margin-bottom: 20px; color: #dc3545; font-size: 18px;">Удаление рабочей области</h4>
                    
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 20px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #721c24; font-weight: bold;">
                            ⚠️ Опасное действие: Удаление рабочей области
                        </p>
                        <p style="margin: 10px 0 0 0; color: #721c24; font-size: 14px;">
                            При удалении рабочей области будут выполнены следующие действия:
                        </p>
                        <ul style="color: #721c24; font-size: 14px; margin: 10px 0 0 20px; padding: 0;">
                            <li>Все команды и их участники будут удалены ({{ teams.count }} команд)</li>
                            <li>Все задачи во всех командах будут удалены ({{ tasks.count }} задач)</li>
                            <li>Все приглашения будут отменены</li>
                            <li>Все настройки доступа будут удалены</li>
                            <li>Все участники будут уведомлены об удалении</li>
                            <li>Это действие нельзя отменить</li>
                        </ul>
                    </div>
                    
                    <form id="deleteWorkspaceForm" style="background: #f8f9fa; padding: 20px; border-radius: 5px;">
                        <div style="margin-bottom: 20px;">
                            <label for="deletePasswordConfirm" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                                Для подтверждения удаления введите ваш пароль:
                            </label>
                            <input type="password" 
                                id="deletePasswordConfirm" 
                                placeholder="Введите ваш пароль"
                                style="width: 100%; padding: 10px; border: 1px solid #dc3545; border-radius: 4px; font-size: 14px;"
                                autocomplete="current-password">
                            <p style="color: #666; font-size: 13px; margin-top: 5px;">
                                Это действие требует подтверждения вашей личности как владельца рабочей области
                            </p>
                        </div>
                        
                        <button type="button" 
                                onclick="confirmWorkspaceDelete()"
                                style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px;">
                            Удалить рабочую область
                        </button>
                    </form>
                    <div id="deleteWorkspaceResult" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
            {% endif %}

            <!-- Управление доступом - только для тех, у кого есть права -->
            {% if can_manage_access %}
            <div id="contentAccess" style="display: none;">
                <h3>Управление доступом</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Настройте права доступа для различных ролей в рабочей области
                </p>

                <!-- Настройки прав рабочей области -->
                <div style="margin-bottom: 30px;">
                    <h4>Права рабочей области</h4>
                    
                    <form id="workspaceAccessForm">
                        {% csrf_token %}
                        
                        {% if workspace_user_membership.role == 'owner' %}
                        <!-- Управление доступом -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Управление доступом</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может управлять доступом к команде (назначать права, массово приглашать и удалять пользователей)
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_manage_access" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Редактирование рабочей области -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Редактирование рабочей области</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может изменять настройки рабочей области
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_workspace" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_workspace" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_workspace" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Создание команд -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Создание команд</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может создавать новые команды в рабочей области
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_teams" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_teams" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_teams" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Создание задач -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Создание задач</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может создавать задачи в рабочей области
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_tasks" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_tasks" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_create_tasks" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Редактирование задач -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Редактирование задач</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может редактировать существующие задачи
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_tasks" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_tasks" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_edit_tasks" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Удаление задач -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Удаление задач</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может удалять задачи
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_delete_tasks" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_delete_tasks" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_delete_tasks" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <!-- Приглашение пользователей -->
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                            <h5 style="margin-top: 0; color: #333;">Приглашение пользователей</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                                Кто может приглашать новых пользователей в рабочую область
                            </p>
                            <div class="role-checkboxes">
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="owner" checked disabled>
                                    Владелец
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="admin">
                                    Администраторы
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" name="can_invite_users" value="member">
                                    Участники
                                </label>
                            </div>
                        </div>

                        <button type="button" onclick="saveWorkspaceAccessSettings()" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px;">
                            Сохранить настройки доступа
                        </button>
                    </form>

                    <div id="workspaceAccessResult" style="margin-top: 15px; display: none;"></div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальные окна для административных действий -->
{% if workspace_user_membership.role == 'owner' %}
<!-- Модальное окно подтверждения назначения -->
<div id="confirmPromoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение назначения</h3>
    <p id="confirmPromoteMessage">Вы уверены, что хотите назначить выбранных пользователей администраторами?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmPromoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="promoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Назначить
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения разжалования -->
<div id="confirmDemoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение разжалования</h3>
    <p id="confirmDemoteMessage">Вы уверены, что хотите разжаловать выбранных администраторов?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmDemoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="demoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            Разжаловать
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения передачи владельца -->
<div id="confirmOwnerTransferModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002;">
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 30px; width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1003;">
        <h3 style="margin-top: 0; color: #dc3545; margin-bottom: 15px;">
            ⚠️ Подтверждение передачи владельца
        </h3>
        
        <div id="ownerTransferConfirmMessage" style="margin-bottom: 20px; line-height: 1.5; color: #333;">
            <p style="margin-bottom: 10px;"><strong>Вы уверены, что хотите передать роль владельца рабочей области?</strong></p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                После передачи:
                <ul style="color: #666; font-size: 13px; padding-left: 20px; margin: 10px 0;">
                    <li>Новый владелец получит полный контроль над рабочей областью</li>
                    <li>Вы станете администратором рабочей области</li>
                    <li>Это действие не может быть отменено автоматически</li>
                    <li>Все участники будут уведомлены об изменении владельца</li>
                </ul>
            </p>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
            <button type="button" 
                    onclick="closeOwnerTransferModal()"
                    style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Отмена
            </button>
            <button type="button" 
                    onclick="transferOwnerRole()"
                    style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Подтвердить передачу
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления рабочей области -->
<div id="confirmDeleteWorkspaceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1002;">
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 30px; width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1003;">
        <h3 style="margin-top: 0; color: #dc3545; margin-bottom: 15px; border-bottom: 2px solid #f5c6cb; padding-bottom: 10px;">
            ⚠️ Подтверждение удаления рабочей области
        </h3>
        
        <div id="deleteWorkspaceConfirmMessage" style="margin-bottom: 20px; line-height: 1.5; color: #333;">
            <p style="margin-bottom: 15px; font-weight: bold; color: #721c24;">
                Вы собираетесь удалить рабочую область <strong>"{{ workspace.name }}"</strong>
            </p>
            
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                <p style="margin: 0 0 10px 0; color: #721c24; font-weight: bold;">
                    Это действие приведет к:
                </p>
                <ul style="color: #721c24; margin: 0; padding-left: 20px;">
                    <li>Удалению всех команд ({{ teams.count }} команд)</li>
                    <li>Удалению всех задач ({{ tasks.count }} задач)</li>
                    <li>Удалению всех участников из рабочей области</li>
                    <li>Удалению всех приглашений и настроек доступа</li>
                    <li>Все участники будут уведомлены об удалении</li>
                    <li style="font-weight: bold;">Это действие нельзя отменить!</li>
                </ul>
            </div>
            
            <p style="color: #856404; font-size: 14px; background: #fff3cd; padding: 10px; border-radius: 4px;">
                <strong>Внимание:</strong> Все данные будут безвозвратно удалены. 
                Убедитесь, что вы сохранили необходимую информацию.
            </p>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
            <button type="button" 
                    onclick="closeDeleteWorkspaceModal()"
                    style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; min-width: 100px;">
                Отмена
            </button>
            <button type="button" 
                    onclick="deleteWorkspace()"
                    id="confirmDeleteWorkspaceBtn"
                    style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; min-width: 100px;">
                Удалить
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// Управление модальным окном
function openManagement() {
    document.getElementById('managementBlock').style.display = 'block';
}

function openManagementWithMembers() {
    document.getElementById('managementBlock').style.display = 'block';
    showContent('members');
}

function closeManagement() {
    document.getElementById('managementBlock').style.display = 'none';
}

function showContent(section) {
    document.querySelectorAll('[id^="content"]').forEach(el => el.style.display = 'none');
    document.querySelectorAll('[id^="nav"]').forEach(el => el.style.background = '');
    
    const contentElement = document.getElementById(`content${section.charAt(0).toUpperCase() + section.slice(1)}`);
    if (contentElement) {
        contentElement.style.display = 'block';
        document.getElementById(`nav${section.charAt(0).toUpperCase() + section.slice(1)}`).style.background = '#f0f0f0';
        
        if (section === 'members') initMembersSection();
        if (section === 'access') {
            // Загружаем настройки при открытии вкладки доступа
            loadAccessSettings();
        }
    }
}

// Функция для загрузки настроек доступа через AJAX
function loadAccessSettings() {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:get_workspace_access_settings' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCheckboxState(data.access_data);
        } else {
            console.error('Error loading access settings:', data.error);
            document.getElementById('workspaceAccessResult').innerHTML = 
                '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка загрузки настроек доступа</div>';
            document.getElementById('workspaceAccessResult').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('workspaceAccessResult').innerHTML = 
            '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при загрузке настроек</div>';
        document.getElementById('workspaceAccessResult').style.display = 'block';
    });
}

// Функция для обновления состояния чекбоксов на основе данных
function updateCheckboxState(settings) {
    const permissions = [
        'can_manage_access',
        'can_edit_workspace', 
        'can_create_teams',
        'can_create_tasks',
        'can_edit_tasks',
        'can_delete_tasks',
        'can_invite_users'
    ];
    
    permissions.forEach(permission => {
        const roles = settings[permission] || [];
        const checkboxes = document.querySelectorAll(`input[name="${permission}"]`);
        
        checkboxes.forEach(checkbox => {
            if (checkbox.value === 'owner') {
                // Владелец всегда отмечен и заблокирован
                checkbox.checked = true;
                checkbox.disabled = true;
            } else {
                // Для других ролей устанавливаем состояние из загруженных данных
                checkbox.checked = roles.includes(checkbox.value);
                checkbox.disabled = false;
            }
        });
    });
}

// Сохранение основных настроек рабочей области
// Функция для сохранения основных настроек рабочей области
function saveWorkspaceMainSettings() {
    const name = document.getElementById('workspaceName').value.trim();
    const description = document.getElementById('workspaceDescription').value.trim();
    const saveBtn = document.getElementById('saveWorkspaceSettingsBtn');

    // Валидация на клиенте
    if (!name) {
        showWorkspaceEditResult('Название рабочей области не может быть пустым', 'error');
        return;
    }

    if (name.length > 255) {
        showWorkspaceEditResult('Название рабочей области не может превышать 255 символов', 'error');
        return;
    }

    if (description.length > 255) {
        showWorkspaceEditResult('Описание рабочей области не может превышать 255 символов', 'error');
        return;
    }

    // Показываем индикатор загрузки
    const originalBtnText = saveBtn.textContent;
    saveBtn.textContent = 'Сохранение...';
    saveBtn.disabled = true;
    saveBtn.style.opacity = '0.7';
    saveBtn.style.cursor = 'wait';
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_edit' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = data.message;
            
            if (data.changes && data.changes.length > 0) {
                successMessage += '<br><br><strong>Изменения:</strong><br>';
                successMessage += data.changes.map(change => `• ${change}`).join('<br>');
            }
            
            showWorkspaceEditResult(successMessage, 'success');
            
            // Обновляем заголовок страницы
            const pageTitle = document.querySelector('h1');
            if (pageTitle) {
                pageTitle.textContent = data.workspace.name;
            }
            
            // Обновляем хлебные крошки, если они есть
            const breadcrumbs = document.querySelectorAll('.breadcrumb-item');
            if (breadcrumbs.length > 0) {
                breadcrumbs[breadcrumbs.length - 1].textContent = data.workspace.name;
            }
            
            // Сохраняем новые значения для сброса формы
            window.lastSavedWorkspaceData = {
                name: data.workspace.name,
                description: data.workspace.description || ''
            };
            
            // Обновляем страницу через 3 секунды
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
        } else {
            // Показываем ошибку
            showWorkspaceEditResult(data.error || 'Произошла ошибка при сохранении', 'error');
            saveBtn.textContent = originalBtnText;
            saveBtn.disabled = false;
            saveBtn.style.opacity = '1';
            saveBtn.style.cursor = 'pointer';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showWorkspaceEditResult('Произошла ошибка при отправке запроса', 'error');
        saveBtn.textContent = originalBtnText;
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
    });
}

// Функция для сброса формы к исходным значениям
function resetWorkspaceForm() {
    const nameInput = document.getElementById('workspaceName');
    const descriptionInput = document.getElementById('workspaceDescription');
    
    if (window.lastSavedWorkspaceData) {
        // Если есть сохраненные данные, используем их
        nameInput.value = window.lastSavedWorkspaceData.name;
        descriptionInput.value = window.lastSavedWorkspaceData.description;
    } else {
        // Иначе используем исходные значения со страницы
        nameInput.value = '{{ workspace.name }}';
        descriptionInput.value = '{{ workspace.description|default:"" }}';
    }
    
    // Скрываем результат
    document.getElementById('workspaceEditResult').style.display = 'none';
}

// Функция для показа результатов редактирования рабочей области
function showWorkspaceEditResult(content, type) {
    const resultDiv = document.getElementById('workspaceEditResult');
    
    // Если content - это HTML, используем innerHTML, иначе создаем текстовый элемент
    if (typeof content === 'string' && content.includes('<')) {
        resultDiv.innerHTML = content;
    } else {
        resultDiv.innerHTML = `
            <div style="padding: 12px; border-radius: 4px; background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; color: ${type === 'success' ? '#155724' : '#721c24'}; border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};">
                ${content}
            </div>
        `;
    }
    
    resultDiv.style.display = 'block';
    resultDiv.style.animation = 'fadeIn 0.3s ease-out';
    
    // Автоматически скрываем сообщения об ошибках через 8 секунд
    if (type === 'error') {
        setTimeout(() => {
            resultDiv.style.opacity = '0';
            resultDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                resultDiv.style.display = 'none';
                resultDiv.style.opacity = '1';
            }, 500);
        }, 8000);
    }
}

// Инициализация при загрузке страницы
// document.addEventListener('DOMContentLoaded', function() {
//     // Сохраняем исходные значения для сброса формы
//     if (document.getElementById('workspaceName')) {
//         window.lastSavedWorkspaceData = {
//             name: '{{ workspace.name }}',
//             description: '{{ workspace.description|default:"" }}'
//         };
//     }
    
//     // Добавляем валидацию в реальном времени
//     const nameInput = document.getElementById('workspaceName');
//     if (nameInput) {
//         nameInput.addEventListener('input', function() {
//             const name = this.value.trim();
//             const resultDiv = document.getElementById('workspaceEditResult');
            
//             if (name.length > 100) {
//                 showWorkspaceEditResult('Название рабочей области не может превышать 100 символов', 'error');
//             } else if (name.length < 2 && name.length > 0) {
//                 showWorkspaceEditResult('Название рабочей области должно содержать минимум 2 символа', 'error');
//             } else {
//                 resultDiv.style.display = 'none';
//             }
//         });
//     }
// });

// Передача владельца рабочей области
function confirmOwnerTransfer() {
    const newOwnerSelect = document.getElementById('newOwnerSelect');
    const passwordInput = document.getElementById('ownerPasswordConfirm');
    
    // Валидация на клиенте
    if (!newOwnerSelect || !newOwnerSelect.value) {
        showOwnerTransferResult('Пожалуйста, выберите нового владельца рабочей области', 'error');
        return;
    }
    
    if (!passwordInput || !passwordInput.value.trim()) {
        showOwnerTransferResult('Для подтверждения необходимо ввести ваш пароль', 'error');
        return;
    }
    
    // Получаем информацию о выбранном владельце
    const selectedOption = newOwnerSelect.options[newOwnerSelect.selectedIndex];
    const newOwnerName = selectedOption.text.split(' (')[0];
    
    // Обновляем текст в модальном окне
    const messageDiv = document.getElementById('ownerTransferConfirmMessage');
    messageDiv.innerHTML = `
        <div style="margin-bottom: 15px;">
            <p style="margin-bottom: 10px;">
                Вы собираетесь передать роль владельца рабочей области пользователю:
            </p>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #dc3545;">
                <strong>${newOwnerName}</strong>
            </div>
            <p style="color: #666; font-size: 14px;">
                После подтверждения:
                <ul style="color: #666; font-size: 13px; margin: 8px 0 8px 20px;">
                    <li>Вы станете администратором рабочей области</li>
                    <li>Новый владелец получит полный контроль над рабочей областью</li>
                    <li>Все участники будут уведомлены об изменении владельца</li>
                    <li>Это действие нельзя отменить</li>
                </ul>
            </p>
        </div>
    `;
    
    // Показываем модальное окно
    document.getElementById('confirmOwnerTransferModal').style.display = 'block';
}

function closeOwnerTransferModal() {
    document.getElementById('confirmOwnerTransferModal').style.display = 'none';
    // Очищаем поле пароля для безопасности
    const passwordInput = document.getElementById('ownerPasswordConfirm');
    if (passwordInput) {
        passwordInput.value = '';
    }
}

function transferOwnerRole() {
    const newOwnerSelect = document.getElementById('newOwnerSelect');
    const passwordInput = document.getElementById('ownerPasswordConfirm');
    
    // Проверяем введенные данные
    if (!newOwnerSelect || !newOwnerSelect.value) {
        showOwnerTransferResult('Пожалуйста, выберите нового владельца рабочей области', 'error');
        return;
    }
    
    if (!passwordInput || !passwordInput.value.trim()) {
        showOwnerTransferResult('Для подтверждения необходимо ввести ваш пароль', 'error');
        return;
    }
    
    // Получаем выбранные данные
    const newOwnerId = newOwnerSelect.value;
    const password = passwordInput.value;
    
    // Показываем индикатор загрузки
    const confirmBtn = document.querySelector('#confirmOwnerTransferModal button[onclick="transferOwnerRole()"]');
    const originalBtnText = confirmBtn.textContent;
    confirmBtn.textContent = 'Обработка...';
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.7';
    confirmBtn.style.cursor = 'wait';
    
    // Создаем FormData для отправки
    const formData = new FormData();
    formData.append('new_owner_id', newOwnerId);
    formData.append('password', password);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Отправляем AJAX запрос
    fetch(`{% url 'workspace:workspace_transfer_owner' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Проверяем статус ответа
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Закрываем модальное окно
        closeOwnerTransferModal();
        
        if (data.success) {
            // Обрабатываем успешный ответ
            handleSuccessfulOwnerTransfer(data);
        } else {
            // Обрабатываем ошибку
            handleOwnerTransferError(data);
        }
    })
    .catch(error => {
        console.error('Ошибка при передаче владельца:', error);
        closeOwnerTransferModal();
        
        showOwnerTransferResult(
            'Произошла ошибка при отправке запроса. Пожалуйста, попробуйте еще раз.', 
            'error'
        );
        
        // Восстанавливаем кнопку
        confirmBtn.textContent = originalBtnText;
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
    });
}

// Обработка успешной передачи владельца
function handleSuccessfulOwnerTransfer(responseData) {
    const data = responseData.data;
    
    // Формируем подробное сообщение об успехе
    const successMessage = `
        <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
            <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                ✅ ${responseData.message}
            </div>
            <div style="font-size: 14px;">
                <p style="margin: 5px 0;">
                    <strong>Новый владелец:</strong> ${data.new_owner.full_name} (@${data.new_owner.username})
                </p>
                <p style="margin: 5px 0;">
                    <strong>Ваша новая роль:</strong> ${data.current_user.role_display}
                </p>
                <p style="margin: 5px 0; font-size: 13px; color: #0c5460;">
                    Страница будет автоматически обновлена...
                </p>
            </div>
        </div>
    `;
    
    // Показываем сообщение
    showOwnerTransferResult(successMessage, 'success');
    
    // Обновляем страницу через 3 секунды
    setTimeout(() => {
        window.location.reload();
    }, 3000);
}

// Обработка ошибки при передаче владельца
function handleOwnerTransferError(errorData) {
    // Формируем сообщение об ошибке
    const errorMessage = `
        <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24;">
            <div style="font-weight: bold; margin-bottom: 5px; font-size: 16px;">
                ❌ ${errorData.error}
            </div>
            ${errorData.debug_info ? 
                `<div style="margin-top: 10px; padding: 8px; background: #f1f1f1; border-radius: 3px; font-size: 12px; color: #721c24;">
                    <strong>Отладочная информация:</strong><br>
                    ${errorData.debug_info}
                </div>` 
                : ''
            }
        </div>
    `;
    
    // Показываем сообщение об ошибке
    showOwnerTransferResult(errorMessage, 'error');
    
    // Восстанавливаем кнопку в модальном окне
    const confirmBtn = document.querySelector('#confirmOwnerTransferModal button[onclick="transferOwnerRole()"]');
    if (confirmBtn) {
        confirmBtn.textContent = 'Подтвердить передачу';
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
    }
}

// Функция для показа результатов передачи владельца
function showOwnerTransferResult(content, type) {
    const resultDiv = document.getElementById('ownerTransferResult');
    
    // Если content - это HTML, используем innerHTML, иначе создаем текстовый элемент
    if (typeof content === 'string' && content.includes('<')) {
        resultDiv.innerHTML = content;
    } else {
        resultDiv.innerHTML = `
            <div style="padding: 12px; border-radius: 4px; background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; color: ${type === 'success' ? '#155724' : '#721c24'}; border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};">
                ${content}
            </div>
        `;
    }
    
    resultDiv.style.display = 'block';
    resultDiv.style.animation = 'fadeIn 0.3s ease-out';
    
    // Автоматически скрываем сообщения об ошибках через 8 секунд
    if (type === 'error') {
        setTimeout(() => {
            resultDiv.style.opacity = '0';
            resultDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                resultDiv.style.display = 'none';
                resultDiv.style.opacity = '1';
            }, 500);
        }, 8000);
    }
}

// Удаление рабочей области
function confirmWorkspaceDelete() {
    const passwordInput = document.getElementById('deletePasswordConfirm');
    if (!passwordInput || !passwordInput.value.trim()) {
        showWorkspaceDeleteResult('Для подтверждения удаления необходимо ввести ваш пароль', 'error');
        return;
    }
    
    // Показываем модальное окно подтверждения
    document.getElementById('confirmDeleteWorkspaceModal').style.display = 'block';
}

function closeDeleteWorkspaceModal() {
    document.getElementById('confirmDeleteWorkspaceModal').style.display = 'none';
    // Очищаем поле пароля для безопасности
    const passwordInput = document.getElementById('deletePasswordConfirm');
    if (passwordInput) {
        passwordInput.value = '';
    }
}

function deleteWorkspace() {
    // Показываем индикатор загрузки
    const confirmBtn = document.getElementById('confirmDeleteWorkspaceBtn');
    const originalBtnText = confirmBtn.textContent;
    confirmBtn.textContent = 'Удаление...';
    confirmBtn.disabled = true;
    confirmBtn.style.opacity = '0.7';
    confirmBtn.style.cursor = 'wait';
    
    // Получаем пароль
    const passwordInput = document.getElementById('deletePasswordConfirm');
    const password = passwordInput ? passwordInput.value.trim() : '';
    
    // Создаем FormData для отправки
    const formData = new FormData();
    formData.append('password', password);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Отправляем AJAX запрос
    fetch(`{% url 'workspace:workspace_delete' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Проверяем статус ответа
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Закрываем модальное окно
        closeDeleteWorkspaceModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            const successMessage = `
                <div style="padding: 20px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
                    <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px;">
                        ✅ ${data.message}
                    </div>
                    <div style="font-size: 14px;">
                        <p style="margin: 5px 0;">
                            <strong>Рабочая область:</strong> ${data.stats.workspace_name}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>Удалено команд:</strong> ${data.stats.teams_count}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>Удалено задач:</strong> ${data.stats.tasks_count}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>Участников уведомлено:</strong> ${data.stats.members_count}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 13px; color: #0c5460;">
                            Перенаправление на список рабочих областей...
                        </p>
                    </div>
                </div>
            `;
            
            showWorkspaceDeleteResult(successMessage, 'success');
            
            // Перенаправляем на список рабочих областей через 3 секунды
            setTimeout(() => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '/workspaces/';
                }
            }, 3000);
            
        } else {
            // Обрабатываем ошибку
            const errorMessage = `
                <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24;">
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 16px;">
                        ❌ ${data.error}
                    </div>
                    ${data.debug_info ? 
                        `<div style="margin-top: 10px; padding: 8px; background: #f1f1f1; border-radius: 3px; font-size: 12px; color: #721c24;">
                            <strong>Отладочная информация:</strong><br>
                            ${data.debug_info}
                        </div>` 
                        : ''
                    }
                </div>
            `;
            
            showWorkspaceDeleteResult(errorMessage, 'error');
            
            // Восстанавливаем кнопку
            confirmBtn.textContent = originalBtnText;
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
            confirmBtn.style.cursor = 'pointer';
        }
    })
    .catch(error => {
        console.error('Ошибка при удалении рабочей области:', error);
        closeDeleteWorkspaceModal();
        
        const errorMessage = `
            <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; color: #721c24;">
                <div style="font-weight: bold; margin-bottom: 5px; font-size: 16px;">
                    ❌ Произошла ошибка при отправке запроса
                </div>
            </div>
        `;
        
        showWorkspaceDeleteResult(errorMessage, 'error');
        
        // Восстанавливаем кнопку
        confirmBtn.textContent = originalBtnText;
        confirmBtn.disabled = false;
        confirmBtn.style.opacity = '1';
        confirmBtn.style.cursor = 'pointer';
    });
}

// Функция для показа результатов удаления рабочей области
function showWorkspaceDeleteResult(content, type) {
    const resultDiv = document.getElementById('deleteWorkspaceResult');
    
    // Если content - это HTML, используем innerHTML, иначе создаем текстовый элемент
    if (typeof content === 'string' && content.includes('<')) {
        resultDiv.innerHTML = content;
    } else {
        resultDiv.innerHTML = `
            <div style="padding: 12px; border-radius: 4px; background: ${type === 'success' ? '#d4edda' : '#f8d7da'}; color: ${type === 'success' ? '#155724' : '#721c24'}; border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};">
                ${content}
            </div>
        `;
    }
    
    resultDiv.style.display = 'block';
    resultDiv.style.animation = 'fadeIn 0.3s ease-out';
    
    // Автоматически скрываем сообщения об ошибках через 8 секунд
    if (type === 'error') {
        setTimeout(() => {
            resultDiv.style.opacity = '0';
            resultDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                resultDiv.style.display = 'none';
                resultDiv.style.opacity = '1';
            }, 500);
        }, 8000);
    }
}

// Сохранение настроек доступа рабочей области
function saveWorkspaceAccessSettings() {
    const form = document.getElementById('workspaceAccessForm');
    const formData = new FormData();
    
    // Собираем данные из чекбоксов
    const permissions = [
        {% if workspace_user_membership.role == 'owner' %}'can_manage_access'{% endif %},
        'can_edit_workspace', 
        'can_create_teams',
        'can_create_tasks',
        'can_edit_tasks',
        'can_delete_tasks',
        'can_invite_users'
    ];
    
    permissions.forEach(permission => {
        const checkboxes = form.querySelectorAll(`input[name="${permission}"]:checked`);
        const values = Array.from(checkboxes).map(cb => cb.value);
        formData.append(permission, JSON.stringify(values));
    });
    
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:save_workspace_access_settings' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('workspaceAccessResult');
        
        if (data.success) {
            resultDiv.innerHTML = '<div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Настройки доступа успешно сохранены</div>';
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.error || 'Неизвестная ошибка'}</div>`;
        }
        
        resultDiv.style.display = 'block';
        setTimeout(() => resultDiv.style.display = 'none', 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('workspaceAccessResult').innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при сохранении настроек</div>';
        document.getElementById('workspaceAccessResult').style.display = 'block';
    });
}

// Массовое приглашение
function createMassInvitation() {
    const form = document.getElementById('massInvitationForm');
    const formData = new FormData(form);
    
    fetch(`{% url 'workspace:create_mass_invitation' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('massInvitationResult');
        
        if (data.success) {
            let existingDiv = document.getElementById('existingMassInvitation');
            if (!existingDiv) {
                existingDiv = document.createElement('div');
                existingDiv.id = 'existingMassInvitation';
                existingDiv.style.cssText = 'margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef;';
                form.parentNode.insertBefore(existingDiv, form);
            }
            
            existingDiv.innerHTML = `
                <p style="margin: 0 0 10px 0; font-weight: bold; color: #155724;">✅ Новая активная ссылка:</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="existingInvitationLink" value="${data.invitation_url}" readonly style="flex: 1; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: #fff;">
                    <button type="button" onclick="copyExistingInvitationLink()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Копировать</button>
                </div>
                <div style="font-size: 12px; color: #155724;">
                    <div>Срок действия: ${data.expiration_time}</div>
                    <div>Использований: ${data.max_uses} (текущее: ${data.current_uses})</div>
                    <div>Статус: <span style="color: #28a745;">Активно</span></div>
                </div>
            `;
            
            document.querySelector('#massInvitationForm button').textContent = 'Обновить ссылку';
            document.getElementById('toggleAllInvitations').checked = true;
            document.querySelector('#toggleAllInvitations + span').textContent = 'Активно';
            
            resultDiv.innerHTML = '<div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Создана новая ссылка приглашения</div>';
            resultDiv.style.display = 'block';
            setTimeout(() => resultDiv.style.display = 'none', 3000);
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.errors ? Object.values(data.errors).join(', ') : (data.error || 'Неизвестная ошибка')}</div>`;
            resultDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('massInvitationResult').innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при создании приглашения</div>';
        document.getElementById('massInvitationResult').style.display = 'block';
    });
}

function copyExistingInvitationLink() {
    const linkInput = document.getElementById('existingInvitationLink');
    linkInput.select();
    document.execCommand('copy');
    const button = event.target;
    button.textContent = 'Скопировано!';
    setTimeout(() => button.textContent = 'Копировать', 2000);
}

// Точечное приглашение
let tempIdentifiers = [];

// Обработка ввода - работает на пробел и Enter
document.getElementById('identifiersInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const identifier = this.value.trim();
        if (identifier && !tempIdentifiers.includes(identifier)) {
            tempIdentifiers.push(identifier);
            updateIdentifiersList();
        }
        this.value = '';
    }
});

// Также обрабатываем ввод для пробела в конце
document.getElementById('identifiersInput').addEventListener('input', function(e) {
    const value = this.value.trim();
    if (value.endsWith(' ')) {
        const identifier = value.slice(0, -1).trim();
        if (identifier && !tempIdentifiers.includes(identifier)) {
            tempIdentifiers.push(identifier);
            updateIdentifiersList();
        }
        this.value = '';
    }
});

function updateIdentifiersList() {
    const listDiv = document.getElementById('identifiersList');
    listDiv.innerHTML = '';
    
    tempIdentifiers.forEach((identifier, index) => {
        const badge = document.createElement('div');
        badge.style.cssText = 'background: #007bff; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; margin: 2px;';
        badge.innerHTML = `${identifier} <span style="cursor: pointer; font-weight: bold;" onclick="removeIdentifier(${index})">×</span>`;
        listDiv.appendChild(badge);
    });
}

function removeIdentifier(index) {
    tempIdentifiers.splice(index, 1);
    updateIdentifiersList();
}

function createIndividualInvitations() {
    if (tempIdentifiers.length === 0) {
        alert('Добавьте хотя бы один email или код пользователя');
        return;
    }
    
    const formData = new FormData();
    formData.append('identifiers', tempIdentifiers.join(' '));
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:create_individual_invitations' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('individualInvitationResult');
        
        if (data.success) {
            resultDiv.innerHTML = `<div style="color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Отправлено ${data.created_count} приглашений${data.errors.length > 0 ? '<br>Ошибки: ' + data.errors.join(', ') : ''}</div>`;
            tempIdentifiers = [];
            updateIdentifiersList();
            document.getElementById('identifiersInput').value = '';
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.error || 'Неизвестная ошибка'}</div>`;
        }
        
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при отправке приглашений');
    });
}

// Управление приглашениями
function toggleAllInvitations() {
    const checkbox = document.getElementById('toggleAllInvitations');
    const action = checkbox.checked ? 'enable' : 'disable';
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:toggle_all_invitations' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector('#toggleAllInvitations + span').textContent = checkbox.checked ? 'Активно' : 'Неактивно';
        } else {
            alert('Ошибка при изменении статуса');
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка');
        checkbox.checked = !checkbox.checked;
    });
}

// Функционал удаления участников
let kickMode = false;
let selectedUsersToKick = [];

// Включение/выключение режима удаления
function toggleKickMode() {
    kickMode = !kickMode;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    const kickBtn = document.getElementById('kickMembersBtn');
    const cancelBtn = document.getElementById('cancelKickBtn');
    const kickActions = document.getElementById('kickActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = kickMode ? 'block' : 'none';
    });
    
    kickBtn.style.display = kickMode ? 'none' : 'block';
    cancelBtn.style.display = kickMode ? 'block' : 'none';
    kickActions.style.display = kickMode ? 'block' : 'none';
    
    if (!kickMode) {
        selectedUsersToKick = [];
        updateSelectedCount();
    }
}

function cancelKickMode() {
    kickMode = false;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('kickMembersBtn').style.display = 'block';
    document.getElementById('cancelKickBtn').style.display = 'none';
    document.getElementById('kickActions').style.display = 'none';
    
    selectedUsersToKick = [];
    updateSelectedCount();
}

// Обновление счетчика выбранных пользователей
function updateSelectedCount() {
    const selectedCount = document.getElementById('selectedCount');
    const count = selectedUsersToKick.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('kick-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToKick.includes(userId)) {
                selectedUsersToKick.push(userId);
            }
        } else {
            const index = selectedUsersToKick.indexOf(userId);
            if (index > -1) {
                selectedUsersToKick.splice(index, 1);
            }
        }
        
        updateSelectedCount();
    }
});

// Подтверждение удаления
function confirmKickMembers() {
    if (selectedUsersToKick.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для удаления');
        return;
    }
    
    const confirmModal = document.getElementById('confirmKickModal');
    const message = document.getElementById('confirmKickMessage');
    
    if (selectedUsersToKick.length === 1) {
        message.textContent = 'Вы уверены, что хотите удалить выбранного пользователя из рабочей области?';
    } else {
        message.textContent = `Вы уверены, что хотите удалить ${selectedUsersToKick.length} пользователей из рабочей области?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmKickModal() {
    document.getElementById('confirmKickModal').style.display = 'none';
}

// Удаление пользователей
function kickMembers() {
    const formData = new FormData();
    selectedUsersToKick.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_kick_members' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmKickModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно удалено пользователей: ${data.removed_count}`;
            if (data.removed_users && data.removed_users.length > 0) {
                const userNames = data.removed_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            // alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

// Функционал управления ролями
let promoteMode = false;
let demoteMode = false;
let selectedUsersToPromote = [];
let selectedUsersToDemote = [];

// Назначение администраторов
function togglePromoteMode() {
    promoteMode = !promoteMode;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    const promoteBtn = document.getElementById('promoteMembersBtn');
    const cancelBtn = document.getElementById('cancelPromoteBtn');
    const promoteActions = document.getElementById('promoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = promoteMode ? 'block' : 'none';
    });
    
    promoteBtn.style.display = promoteMode ? 'none' : 'block';
    cancelBtn.style.display = promoteMode ? 'block' : 'none';
    promoteActions.style.display = promoteMode ? 'block' : 'none';
    
    if (!promoteMode) {
        selectedUsersToPromote = [];
        updatePromoteSelectedCount();
    }
}

function cancelPromoteMode() {
    promoteMode = false;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('promoteMembersBtn').style.display = 'block';
    document.getElementById('cancelPromoteBtn').style.display = 'none';
    document.getElementById('promoteActions').style.display = 'none';
    
    selectedUsersToPromote = [];
    updatePromoteSelectedCount();
}

function updatePromoteSelectedCount() {
    const selectedCount = document.getElementById('promoteSelectedCount');
    const count = selectedUsersToPromote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Разжалование администраторов
function toggleDemoteMode() {
    demoteMode = !demoteMode;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    const demoteBtn = document.getElementById('demoteMembersBtn');
    const cancelBtn = document.getElementById('cancelDemoteBtn');
    const demoteActions = document.getElementById('demoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = demoteMode ? 'block' : 'none';
    });
    
    demoteBtn.style.display = demoteMode ? 'none' : 'block';
    cancelBtn.style.display = demoteMode ? 'block' : 'none';
    demoteActions.style.display = demoteMode ? 'block' : 'none';
    
    if (!demoteMode) {
        selectedUsersToDemote = [];
        updateDemoteSelectedCount();
    }
}

function cancelDemoteMode() {
    demoteMode = false;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('demoteMembersBtn').style.display = 'block';
    document.getElementById('cancelDemoteBtn').style.display = 'none';
    document.getElementById('demoteActions').style.display = 'none';
    
    selectedUsersToDemote = [];
    updateDemoteSelectedCount();
}

function updateDemoteSelectedCount() {
    const selectedCount = document.getElementById('demoteSelectedCount');
    const count = selectedUsersToDemote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов для назначения
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('promote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToPromote.includes(userId)) {
                selectedUsersToPromote.push(userId);
            }
        } else {
            const index = selectedUsersToPromote.indexOf(userId);
            if (index > -1) {
                selectedUsersToPromote.splice(index, 1);
            }
        }
        
        updatePromoteSelectedCount();
    }
});

// Обработка выбора чекбоксов для разжалования
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('demote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToDemote.includes(userId)) {
                selectedUsersToDemote.push(userId);
            }
        } else {
            const index = selectedUsersToDemote.indexOf(userId);
            if (index > -1) {
                selectedUsersToDemote.splice(index, 1);
            }
        }
        
        updateDemoteSelectedCount();
    }
});

// Подтверждение назначения
function confirmPromoteMembers() {
    if (selectedUsersToPromote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для назначения');
        return;
    }
    
    const confirmModal = document.getElementById('confirmPromoteModal');
    const message = document.getElementById('confirmPromoteMessage');
    
    if (selectedUsersToPromote.length === 1) {
        message.textContent = 'Вы уверены, что хотите назначить выбранного пользователя администратором?';
    } else {
        message.textContent = `Вы уверены, что хотите назначить ${selectedUsersToPromote.length} пользователей администраторами?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmPromoteModal() {
    document.getElementById('confirmPromoteModal').style.display = 'none';
}

// Подтверждение разжалования
function confirmDemoteMembers() {
    if (selectedUsersToDemote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного администратора для разжалования');
        return;
    }
    
    const confirmModal = document.getElementById('confirmDemoteModal');
    const message = document.getElementById('confirmDemoteMessage');
    
    if (selectedUsersToDemote.length === 1) {
        message.textContent = 'Вы уверены, что хотите разжаловать выбранного администратора?';
    } else {
        message.textContent = `Вы уверены, что хотите разжаловать ${selectedUsersToDemote.length} администраторов?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmDemoteModal() {
    document.getElementById('confirmDemoteModal').style.display = 'none';
}

// Назначение администраторов
function promoteMembers() {
    const formData = new FormData();
    selectedUsersToPromote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'promote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_change_member_role' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmPromoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно назначено администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

// Разжалование администраторов
function demoteMembers() {
    const formData = new FormData();
    selectedUsersToDemote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'demote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_change_member_role' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmDemoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно разжаловано администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

function initMembersSection() {
    tempIdentifiers = [];
    updateIdentifiersList();
}
</script>

{% endblock %}