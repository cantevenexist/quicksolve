{% extends 'layout.html' %}
{% block content %}

<div style="display: flex; flex-direction: row;">
    <h1>{{ workspace.name }}</h1>

    <!-- Кнопка управления -->
    <button onclick="openManagement()" style="cursor: pointer; height: 40px;">Управление</button>
</div>

<!-- Количество участников -->
<div style="cursor: pointer; color: #666; margin-bottom: 20px;" onclick="openManagementWithMembers()">
    {% with total_members=workspace.members.count %}
        {{ total_members }} участник{{ total_members|pluralize:"ов" }}
    {% endwith %}
</div>

<!-- Команды -->
<h2>Команды:</h2>
<a href="{% url 'workspace:team_create' workspace.url_hash %}">Создать команду</a>

{% if teams %}
    <ul>
    {% for team in teams %}
        <li>
            <a href="{% url 'workspace:team_detail' workspace.url_hash team.url_hash %}">
                {{ team.name }}
            </a>
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>Нет команд</p>
{% endif %}

<!-- Задачи -->
<h2>Задачи:</h2>
<a href="{% url 'workspace:task_create' workspace.url_hash %}">Создать задачу</a>
<a href="{% url 'workspace:task_list' workspace.url_hash %}">Все задачи</a>

<!-- Блок управления -->
<div id="managementBlock" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1000; width: 80%; max-width: 800px;">
    <div style="position: absolute; top: 10px; right: 10px; cursor: pointer;" onclick="closeManagement()">✕</div>
    
    <div style="display: flex;">
        <!-- Навигация -->
        <div style="width: 30%; border-right: 1px solid #ccc; padding-right: 20px;">
            <div id="navMain" style="cursor: pointer; padding: 10px; background: #f0f0f0;" onclick="showContent('main')">Главное</div>
            <div id="navMembers" style="cursor: pointer; padding: 10px;" onclick="showContent('members')">Участники</div>
            <div id="navAdmin" style="cursor: pointer; padding: 10px;" onclick="showContent('admin')">Администрирование</div>
        </div>
        
        <!-- Контент -->
        <div style="width: 70%; padding-left: 20px;">
            <!-- Главное -->
            <div id="contentMain" style="display: block;">
                <h3>Основные настройки</h3>
                <form>
                    <div>
                        <label>Название:</label>
                        <input type="text" value="{{ workspace.name }}" style="width: 100%; margin-bottom: 10px;">
                    </div>
                    <div>
                        <label>Описание:</label>
                        <textarea style="width: 100%; height: 100px; margin-bottom: 10px;">{{ workspace.description|default:'' }}</textarea>
                    </div>
                    <button type="button">Сохранить</button>
                </form>
            </div>
            
            <!-- Участники -->
<div id="contentMembers" style="display: none;">
    <h3>Участники рабочей области</h3>
    
    <!-- Текущие участники -->
    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0;">Текущие участники</h4>
            <div>
                <button id="kickMembersBtn" type="button" onclick="toggleKickMode()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Удалить
                </button>
                <button id="cancelKickBtn" type="button" onclick="cancelKickMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                    Отменить
                </button>
            </div>
        </div>
        
        <div id="membersList">
            {% for member in members %}
                <div class="member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                    <input type="checkbox" name="kick_user_ids" value="{{ member.user.id }}" 
                           style="margin-right: 10px; display: none;" 
                           class="kick-checkbox"
                           {% if member.user == request.user or member.role == 'owner' %}disabled{% endif %}>
                    <div style="flex: 1;">
                        {{ member.user }} ({{ member.get_role_display }})
                        {% if member.user == request.user %}<span style="color: #666;">(Вы)</span>{% endif %}
                    </div>
                </div>
            {% empty %}
                <li>Нет других участников</li>
            {% endfor %}
        </div>
        
        <div id="kickActions" style="margin-top: 15px; display: none;">
            <button type="button" onclick="confirmKickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Удалить выбранных
            </button>
            <span id="selectedCount" style="margin-left: 10px; color: #666;"></span>
        </div>
    </div>

    <!-- Массовое приглашение -->
    <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h4>Массовое приглашение</h4>
        
        {% if mass_invitation_url %}
        <div id="existingMassInvitation" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef;">
            <p style="margin: 0 0 10px 0; font-weight: bold;">
                {% if mass_invitation_data.can_be_used %}Текущая активная ссылка:{% else %}Текущая ссылка (неактивна):{% endif %}
            </p>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="existingInvitationLink" value="{{ mass_invitation_url }}" readonly 
                       style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #fff;">
                <button type="button" onclick="copyExistingInvitationLink()" 
                        style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                    Копировать
                </button>
            </div>
            <div style="font-size: 12px; color: #666;">
                <div>Срок действия: {{ mass_invitation_data.expiration_time }}</div>
                <div>Использований: {{ mass_invitation_data.max_uses }} (текущее: {{ mass_invitation_data.current_uses }})</div>
                <div>Статус: 
                    <span class="status-indicator" data-status="{% if mass_invitation_data.can_be_used %}active{% else %}inactive{% endif %}">
                        {% if mass_invitation_data.can_be_used %}Активно{% else %}Неактивно{% endif %}
                    </span>
                    <style>
                    .status-indicator[data-status="active"] { color: #28a745; }
                    .status-indicator[data-status="inactive"] { color: #dc3545; }
                    </style>
                </div>
            </div>
        </div>
        {% endif %}
        
        <form id="massInvitationForm">
            {% csrf_token %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Срок действия:</label>
                <select name="expiration_time" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">Бессрочно</option>
                    <option value="3600">1 час</option>
                    <option value="14400">4 часа</option>
                    <option value="86400">24 часа</option>
                    <option value="172800">48 часов</option>
                    <option value="259200">72 часа</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Количество использований:</label>
                <input type="number" name="max_uses" min="1" placeholder="Оставьте пустым для безграничного использования"
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            
            <button type="button" onclick="createMassInvitation()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                {% if mass_invitation_url %}Обновить ссылку{% else %}Создать ссылку{% endif %}
            </button>
        </form>
        
        <div id="massInvitationResult" style="margin-top: 15px; display: none;"></div>
    </div>

    <!-- Точечное приглашение -->
    <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h4>Точечное приглашение</h4>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
            Введите почты или уникальные коды через пробел или Enter
        </p>
        
        <form id="individualInvitationForm">
            {% csrf_token %}
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Почты или коды:</label>
                <input type="text" id="identifiersInput" 
                       placeholder="user1@example.com ABC123 user2@example.com"
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                
                <div id="identifiersList" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
            </div>
            
            <button type="button" onclick="createIndividualInvitations()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Отправить приглашения
            </button>
        </form>
        
        <div id="individualInvitationResult" style="margin-top: 15px; display: none;"></div>
    </div>

    <!-- Управление приглашениями -->
    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa;">
        <h4>Управление приглашениями</h4>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span>Статус массового приглашения:</span>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="toggleAllInvitations" {% if mass_invitation_data.is_active %}checked{% endif %} onchange="toggleAllInvitations()" style="margin-right: 8px;">
                <span>{% if mass_invitation_data.is_active %}Активно{% else %}Неактивно{% endif %}</span>
            </label>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="confirmKickModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение удаления</h3>
    <p id="confirmKickMessage">Вы уверены, что хотите удалить выбранных пользователей из рабочей области?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmKickModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="kickMembers()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Удалить
        </button>
    </div>
</div>

            <!-- Администрирование -->
            <div id="contentAdmin" style="display: none;">
                <h3>Администраторы</h3>
                
                <!-- Назначение администраторов -->
                {% if user_membership.role == 'owner' %}
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Назначить администраторов</h4>
                        <div>
                            <button id="promoteMembersBtn" type="button" onclick="togglePromoteMode()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Назначить
                            </button>
                            <button id="cancelPromoteBtn" type="button" onclick="cancelPromoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="promoteMembersList">
                        {% for member in members %}
                            {% if member.role == 'member' %}
                                <div class="promote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                    <input type="checkbox" name="promote_user_ids" value="{{ member.user.id }}" 
                                           style="margin-right: 10px; display: none;" 
                                           class="promote-checkbox"
                                           data-username="{{ member.user.username }}">
                                    <div style="flex: 1;">
                                        {{ member.user }} ({{ member.get_role_display }})
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <li>Нет обычных участников</li>
                        {% endfor %}
                    </div>
                    
                    <div id="promoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmPromoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Назначить выбранных
                        </button>
                        <span id="promoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>

                <!-- Разжалование администраторов -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Разжаловать администраторов</h4>
                        <div>
                            <button id="demoteMembersBtn" type="button" onclick="toggleDemoteMode()" style="padding: 6px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Разжаловать
                            </button>
                            <button id="cancelDemoteBtn" type="button" onclick="cancelDemoteMode()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                                Отменить
                            </button>
                        </div>
                    </div>
                    
                    <div id="demoteMembersList">
                        {% for member in members %}
                            {% if member.role == 'admin' %}
                                <div class="demote-member-item" style="padding: 8px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                                    <input type="checkbox" name="demote_user_ids" value="{{ member.user.id }}" 
                                           style="margin-right: 10px; display: none;" 
                                           class="demote-checkbox"
                                           data-username="{{ member.user.username }}">
                                    <div style="flex: 1;">
                                        {{ member.user }} ({{ member.get_role_display }})
                                    </div>
                                </div>
                            {% endif %}
                        {% empty %}
                            <li>Нет администраторов</li>
                        {% endfor %}
                    </div>
                    
                    <div id="demoteActions" style="margin-top: 15px; display: none;">
                        <button type="button" onclick="confirmDemoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
                            Разжаловать выбранных
                        </button>
                        <span id="demoteSelectedCount" style="margin-left: 10px; color: #666;"></span>
                    </div>
                </div>
                {% endif %}

                <!-- Список администраторов -->
                <div>
                    <h4>Текущие администраторы</h4>
                    <ul>
                        {% for member in members %}
                            {% if member.get_role_display == "Владелец" or member.get_role_display == "Администратор" %}
                                <li>
                                    {{ member.user }} ({{ member.get_role_display }})
                                    {% if member.user == request.user %}<span style="color: #666;">(Вы)</span>{% endif %}
                                </li>
                            {% endif %}
                        {% empty %}
                            <li>Нет других участников</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения назначения -->
<div id="confirmPromoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение назначения</h3>
    <p id="confirmPromoteMessage">Вы уверены, что хотите назначить выбранных пользователей администраторами?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmPromoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="promoteMembers()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Назначить
        </button>
    </div>
</div>

<!-- Модальное окно подтверждения разжалования -->
<div id="confirmDemoteModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 1px solid #ccc; padding: 20px; z-index: 1001; width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0;">Подтверждение разжалования</h3>
    <p id="confirmDemoteMessage">Вы уверены, что хотите разжаловать выбранных администраторов?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button type="button" onclick="closeConfirmDemoteModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Отмена
        </button>
        <button type="button" onclick="demoteMembers()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer;">
            Разжаловать
        </button>
    </div>
</div>

<script>
// Управление модальным окном
function openManagement() {
    document.getElementById('managementBlock').style.display = 'block';
}

function openManagementWithMembers() {
    document.getElementById('managementBlock').style.display = 'block';
    showContent('members');
}

function closeManagement() {
    document.getElementById('managementBlock').style.display = 'none';
}

function showContent(section) {
    document.querySelectorAll('[id^="content"]').forEach(el => el.style.display = 'none');
    document.querySelectorAll('[id^="nav"]').forEach(el => el.style.background = '');
    
    const contentElement = document.getElementById(`content${section.charAt(0).toUpperCase() + section.slice(1)}`);
    contentElement.style.display = 'block';
    document.getElementById(`nav${section.charAt(0).toUpperCase() + section.slice(1)}`).style.background = '#f0f0f0';
    
    if (section === 'members') initMembersSection();
}

// Массовое приглашение
function createMassInvitation() {
    const form = document.getElementById('massInvitationForm');
    const formData = new FormData(form);
    
    fetch(`{% url 'workspace:create_mass_invitation' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('massInvitationResult');
        
        if (data.success) {
            let existingDiv = document.getElementById('existingMassInvitation');
            if (!existingDiv) {
                existingDiv = document.createElement('div');
                existingDiv.id = 'existingMassInvitation';
                existingDiv.style.cssText = 'margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef;';
                form.parentNode.insertBefore(existingDiv, form);
            }
            
            existingDiv.innerHTML = `
                <p style="margin: 0 0 10px 0; font-weight: bold; color: #155724;">✅ Новая активная ссылка:</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="existingInvitationLink" value="${data.invitation_url}" readonly style="flex: 1; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: #fff;">
                    <button type="button" onclick="copyExistingInvitationLink()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Копировать</button>
                </div>
                <div style="font-size: 12px; color: #155724;">
                    <div>Срок действия: ${data.expiration_time}</div>
                    <div>Использований: ${data.max_uses} (текущее: ${data.current_uses})</div>
                    <div>Статус: <span style="color: #28a745;">Активно</span></div>
                </div>
            `;
            
            document.querySelector('#massInvitationForm button').textContent = 'Обновить ссылку';
            document.getElementById('toggleAllInvitations').checked = true;
            document.querySelector('#toggleAllInvitations + span').textContent = 'Активно';
            
            resultDiv.innerHTML = '<div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Создана новая ссылка приглашения</div>';
            resultDiv.style.display = 'block';
            setTimeout(() => resultDiv.style.display = 'none', 3000);
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.errors ? Object.values(data.errors).join(', ') : (data.error || 'Неизвестная ошибка')}</div>`;
            resultDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('massInvitationResult').innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка при создании приглашения</div>';
        document.getElementById('massInvitationResult').style.display = 'block';
    });
}

function copyExistingInvitationLink() {
    const linkInput = document.getElementById('existingInvitationLink');
    linkInput.select();
    document.execCommand('copy');
    const button = event.target;
    button.textContent = 'Скопировано!';
    setTimeout(() => button.textContent = 'Копировать', 2000);
}

// Точечное приглашение
let tempIdentifiers = [];

// Обработка ввода - работает на пробел и Enter
document.getElementById('identifiersInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const identifier = this.value.trim();
        if (identifier && !tempIdentifiers.includes(identifier)) {
            tempIdentifiers.push(identifier);
            updateIdentifiersList();
        }
        this.value = '';
    }
});

// Также обрабатываем ввод для пробела в конце
document.getElementById('identifiersInput').addEventListener('input', function(e) {
    const value = this.value.trim();
    if (value.endsWith(' ')) {
        const identifier = value.slice(0, -1).trim();
        if (identifier && !tempIdentifiers.includes(identifier)) {
            tempIdentifiers.push(identifier);
            updateIdentifiersList();
        }
        this.value = '';
    }
});

function updateIdentifiersList() {
    const listDiv = document.getElementById('identifiersList');
    listDiv.innerHTML = '';
    
    tempIdentifiers.forEach((identifier, index) => {
        const badge = document.createElement('div');
        badge.style.cssText = 'background: #007bff; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; margin: 2px;';
        badge.innerHTML = `${identifier} <span style="cursor: pointer; font-weight: bold;" onclick="removeIdentifier(${index})">×</span>`;
        listDiv.appendChild(badge);
    });
}

function removeIdentifier(index) {
    tempIdentifiers.splice(index, 1);
    updateIdentifiersList();
}

function createIndividualInvitations() {
    if (tempIdentifiers.length === 0) {
        alert('Добавьте хотя бы один email или код пользователя');
        return;
    }
    
    const formData = new FormData();
    formData.append('identifiers', tempIdentifiers.join(' '));
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:create_individual_invitations' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('individualInvitationResult');
        
        if (data.success) {
            resultDiv.innerHTML = `<div style="color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">✅ Отправлено ${data.created_count} приглашений${data.errors.length > 0 ? '<br>Ошибки: ' + data.errors.join(', ') : ''}</div>`;
            tempIdentifiers = [];
            updateIdentifiersList();
            document.getElementById('identifiersInput').value = '';
        } else {
            resultDiv.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">❌ Ошибка: ${data.error || 'Неизвестная ошибка'}</div>`;
        }
        
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при отправке приглашений');
    });
}

// Управление приглашениями
function toggleAllInvitations() {
    const checkbox = document.getElementById('toggleAllInvitations');
    const action = checkbox.checked ? 'enable' : 'disable';
    
    const formData = new FormData();
    formData.append('action', action);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:toggle_all_invitations' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector('#toggleAllInvitations + span').textContent = checkbox.checked ? 'Активно' : 'Неактивно';
        } else {
            alert('Ошибка при изменении статуса');
            checkbox.checked = !checkbox.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка');
        checkbox.checked = !checkbox.checked;
    });
}

// Функционал удаления участников
let kickMode = false;
let selectedUsersToKick = [];

// Включение/выключение режима удаления
function toggleKickMode() {
    kickMode = !kickMode;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    const kickBtn = document.getElementById('kickMembersBtn');
    const cancelBtn = document.getElementById('cancelKickBtn');
    const kickActions = document.getElementById('kickActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = kickMode ? 'block' : 'none';
    });
    
    kickBtn.style.display = kickMode ? 'none' : 'block';
    cancelBtn.style.display = kickMode ? 'block' : 'none';
    kickActions.style.display = kickMode ? 'block' : 'none';
    
    if (!kickMode) {
        selectedUsersToKick = [];
        updateSelectedCount();
    }
}

function cancelKickMode() {
    kickMode = false;
    const checkboxes = document.querySelectorAll('.kick-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('kickMembersBtn').style.display = 'block';
    document.getElementById('cancelKickBtn').style.display = 'none';
    document.getElementById('kickActions').style.display = 'none';
    
    selectedUsersToKick = [];
    updateSelectedCount();
}

// Обновление счетчика выбранных пользователей
function updateSelectedCount() {
    const selectedCount = document.getElementById('selectedCount');
    const count = selectedUsersToKick.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('kick-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToKick.includes(userId)) {
                selectedUsersToKick.push(userId);
            }
        } else {
            const index = selectedUsersToKick.indexOf(userId);
            if (index > -1) {
                selectedUsersToKick.splice(index, 1);
            }
        }
        
        updateSelectedCount();
    }
});

// Подтверждение удаления
function confirmKickMembers() {
    if (selectedUsersToKick.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для удаления');
        return;
    }
    
    const confirmModal = document.getElementById('confirmKickModal');
    const message = document.getElementById('confirmKickMessage');
    
    if (selectedUsersToKick.length === 1) {
        message.textContent = 'Вы уверены, что хотите удалить выбранного пользователя из рабочей области?';
    } else {
        message.textContent = `Вы уверены, что хотите удалить ${selectedUsersToKick.length} пользователей из рабочей области?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmKickModal() {
    document.getElementById('confirmKickModal').style.display = 'none';
}

// Удаление пользователей
function kickMembers() {
    const formData = new FormData();
    selectedUsersToKick.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_kick_members' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmKickModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно удалено пользователей: ${data.removed_count}`;
            if (data.removed_users && data.removed_users.length > 0) {
                const userNames = data.removed_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            // alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

// Функционал управления ролями
let promoteMode = false;
let demoteMode = false;
let selectedUsersToPromote = [];
let selectedUsersToDemote = [];

// Назначение администраторов
function togglePromoteMode() {
    promoteMode = !promoteMode;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    const promoteBtn = document.getElementById('promoteMembersBtn');
    const cancelBtn = document.getElementById('cancelPromoteBtn');
    const promoteActions = document.getElementById('promoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = promoteMode ? 'block' : 'none';
    });
    
    promoteBtn.style.display = promoteMode ? 'none' : 'block';
    cancelBtn.style.display = promoteMode ? 'block' : 'none';
    promoteActions.style.display = promoteMode ? 'block' : 'none';
    
    if (!promoteMode) {
        selectedUsersToPromote = [];
        updatePromoteSelectedCount();
    }
}

function cancelPromoteMode() {
    promoteMode = false;
    const checkboxes = document.querySelectorAll('.promote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('promoteMembersBtn').style.display = 'block';
    document.getElementById('cancelPromoteBtn').style.display = 'none';
    document.getElementById('promoteActions').style.display = 'none';
    
    selectedUsersToPromote = [];
    updatePromoteSelectedCount();
}

function updatePromoteSelectedCount() {
    const selectedCount = document.getElementById('promoteSelectedCount');
    const count = selectedUsersToPromote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Разжалование администраторов
function toggleDemoteMode() {
    demoteMode = !demoteMode;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    const demoteBtn = document.getElementById('demoteMembersBtn');
    const cancelBtn = document.getElementById('cancelDemoteBtn');
    const demoteActions = document.getElementById('demoteActions');
    
    checkboxes.forEach(checkbox => {
        checkbox.style.display = demoteMode ? 'block' : 'none';
    });
    
    demoteBtn.style.display = demoteMode ? 'none' : 'block';
    cancelBtn.style.display = demoteMode ? 'block' : 'none';
    demoteActions.style.display = demoteMode ? 'block' : 'none';
    
    if (!demoteMode) {
        selectedUsersToDemote = [];
        updateDemoteSelectedCount();
    }
}

function cancelDemoteMode() {
    demoteMode = false;
    const checkboxes = document.querySelectorAll('.demote-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        checkbox.style.display = 'none';
    });
    
    document.getElementById('demoteMembersBtn').style.display = 'block';
    document.getElementById('cancelDemoteBtn').style.display = 'none';
    document.getElementById('demoteActions').style.display = 'none';
    
    selectedUsersToDemote = [];
    updateDemoteSelectedCount();
}

function updateDemoteSelectedCount() {
    const selectedCount = document.getElementById('demoteSelectedCount');
    const count = selectedUsersToDemote.length;
    selectedCount.textContent = `Выбрано: ${count}`;
}

// Обработка выбора чекбоксов для назначения
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('promote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToPromote.includes(userId)) {
                selectedUsersToPromote.push(userId);
            }
        } else {
            const index = selectedUsersToPromote.indexOf(userId);
            if (index > -1) {
                selectedUsersToPromote.splice(index, 1);
            }
        }
        
        updatePromoteSelectedCount();
    }
});

// Обработка выбора чекбоксов для разжалования
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('demote-checkbox')) {
        const userId = e.target.value;
        
        if (e.target.checked) {
            if (!selectedUsersToDemote.includes(userId)) {
                selectedUsersToDemote.push(userId);
            }
        } else {
            const index = selectedUsersToDemote.indexOf(userId);
            if (index > -1) {
                selectedUsersToDemote.splice(index, 1);
            }
        }
        
        updateDemoteSelectedCount();
    }
});

// Подтверждение назначения
function confirmPromoteMembers() {
    if (selectedUsersToPromote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного пользователя для назначения');
        return;
    }
    
    const confirmModal = document.getElementById('confirmPromoteModal');
    const message = document.getElementById('confirmPromoteMessage');
    
    if (selectedUsersToPromote.length === 1) {
        message.textContent = 'Вы уверены, что хотите назначить выбранного пользователя администратором?';
    } else {
        message.textContent = `Вы уверены, что хотите назначить ${selectedUsersToPromote.length} пользователей администраторами?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmPromoteModal() {
    document.getElementById('confirmPromoteModal').style.display = 'none';
}

// Подтверждение разжалования
function confirmDemoteMembers() {
    if (selectedUsersToDemote.length === 0) {
        alert('Пожалуйста, выберите хотя бы одного администратора для разжалования');
        return;
    }
    
    const confirmModal = document.getElementById('confirmDemoteModal');
    const message = document.getElementById('confirmDemoteMessage');
    
    if (selectedUsersToDemote.length === 1) {
        message.textContent = 'Вы уверены, что хотите разжаловать выбранного администратора?';
    } else {
        message.textContent = `Вы уверены, что хотите разжаловать ${selectedUsersToDemote.length} администраторов?`;
    }
    
    confirmModal.style.display = 'block';
}

function closeConfirmDemoteModal() {
    document.getElementById('confirmDemoteModal').style.display = 'none';
}

// Назначение администраторов
function promoteMembers() {
    const formData = new FormData();
    selectedUsersToPromote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'promote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_change_member_role' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmPromoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно назначено администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

// Разжалование администраторов
function demoteMembers() {
    const formData = new FormData();
    selectedUsersToDemote.forEach(userId => {
        formData.append('user_ids[]', userId);
    });
    formData.append('action', 'demote');
    
    // Добавляем CSRF токен
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`{% url 'workspace:workspace_change_member_role' workspace.url_hash %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeConfirmDemoteModal();
        
        if (data.success) {
            // Показываем успешное сообщение
            let successMessage = `Успешно разжаловано администраторов: ${data.updated_count}`;
            if (data.updated_users && data.updated_users.length > 0) {
                const userNames = data.updated_users.map(user => user.username).join(', ');
                successMessage += ` (${userNames})`;
            }
            alert(successMessage);
            
            // Обновляем страницу
            setTimeout(() => {
                location.reload();
            }, 1000);
            
        } else {
            alert(`Ошибка: ${data.error}`);
        }
        
        // Показываем ошибки, если есть
        if (data.errors && data.errors.length > 0) {
            const errorMessage = data.errors.join('\n');
            alert(`Ошибки:\n${errorMessage}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
    });
}

function initMembersSection() {
    tempIdentifiers = [];
    updateIdentifiersList();
}
</script>

{% endblock %}