{% load static %}
<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/layout.css' %}">
    {% block head %}{% endblock %}
    <style>
        .notification-unread {
            background-color: #fff5f5 !important;
            border-left: 3px solid #ff4444;
        }
        
        .notification-read {
            background-color: white !important;
            opacity: 0.7;
        }
        
        .notification-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body style="font-family: Geologica; margin: 0;">
    {% csrf_token %}
    
    <div style="background: #e6e6e6; display: flex; justify-content: space-between; height: 50px;" class="layout_header">
        <div>
            <a href="/">main</a>
        </div>
        
        <div style="display: flex; gap: 15px;">
            {% if user.is_authenticated %}
                <div style="position: relative;">
                    <button onclick="toggleNotifications()" style="background: none; border: none; cursor: pointer;">
                        üîî{% if unread_notifications_count %}({{ unread_notifications_count }}){% endif %}
                    </button>
                </div>
                <a href="/workspace/">workspace</a>
                <a href="/profile/">{{ user.username }}</a>
                <a href="/account/logout/">logout</a>
            {% else %}
                <a href="/account/login/">login</a>
            {% endif %}
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notificationsPreview" style="display: none; position: fixed; top: 50px; right: 0; background: white; border: 1px solid #ccc; width: 250px; max-height: 300px; overflow-y: auto; z-index: 1000;">
        <div style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">
            –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            {% if notifications.count > 5 %}
            <button onclick="showAllNotifications()" style="float: right; background: none; border: none; cursor: pointer;">–í—Å–µ</button>
            {% endif %}
        </div>
        
        {% for notification in recent_notifications %}
            <div onclick="openNotification({{ notification.id }})" 
                    class="notification-item {% if not notification.is_read %}notification-unread{% else %}notification-read{% endif %}">
                <div>{{ notification.message }}</div>
                <small style="color: #666;">{{ notification.created_at|date:"d.m.Y H:i" }}</small>
            </div>
        {% empty %}
            <div style="padding: 20px; text-align: center; color: #666;">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
        {% endfor %}
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="allNotificationsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 0; border-radius: 5px;">
            <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: bold;">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <button onclick="closeAllNotifications()" style="background: none; border: none; cursor: pointer; font-size: 18px;">√ó</button>
            </div>
            <div id="allNotificationsList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="notificationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; width: 90%; max-width: 400px; margin: 50px auto; padding: 0; border-radius: 5px;">
            <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: bold;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
                <button onclick="closeNotification()" style="background: none; border: none; cursor: pointer; font-size: 18px;">√ó</button>
            </div>
            <div style="padding: 20px;">
                <div id="notificationModalContent" style="line-height: 1.5;"></div>
                <div id="notificationModalTime" style="margin-top: 15px; font-size: 12px; color: #666; text-align: right;"></div>
                <div id="notificationModalUrl" style="margin-top: 15px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <div class="scrollable-container">
        <div class="layout_central_block">
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <script>
        function toggleNotifications() {
            const preview = document.getElementById('notificationsPreview');
            preview.style.display = preview.style.display === 'block' ? 'none' : 'block';
        }
        
        function showAllNotifications() {
            document.getElementById('notificationsPreview').style.display = 'none';
            document.getElementById('allNotificationsModal').style.display = 'block';
            loadAllNotifications();
        }
        
        function closeAllNotifications() {
            document.getElementById('allNotificationsModal').style.display = 'none';
        }
        
        function openNotification(notificationId) {
            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
            updateNotificationAppearance(notificationId);
            
            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            markNotificationAsRead(notificationId);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            fetch(`/notifications/${notificationId}/`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('notificationModalContent').textContent = data.notification.message;
                    document.getElementById('notificationModalTime').textContent = data.notification.created_at;
                    
                    const urlContainer = document.getElementById('notificationModalUrl');
                    if (data.notification.related_url) {
                        urlContainer.innerHTML = `<a href="${data.notification.related_url}" style="color: #007bff; text-decoration: none; font-weight: 500;">–ü–µ—Ä–µ–π—Ç–∏ ‚Üí</a>`;
                    } else {
                        urlContainer.innerHTML = '';
                    }
                    
                    document.getElementById('notificationModal').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading notification:', error);
            });
        }
        
        function closeNotification() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        
        function loadAllNotifications() {
            fetch('/notifications/all/', {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('allNotificationsList');
                container.innerHTML = '';
                
                if (data.notifications.length === 0) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                    return;
                }
                
                data.notifications.forEach(notification => {
                    const div = document.createElement('div');
                    div.className = `notification-item ${notification.is_read ? 'notification-read' : 'notification-unread'}`;
                    div.setAttribute('onclick', `openNotification(${notification.id})`);
                    div.innerHTML = `
                        <div>${notification.message}</div>
                        <small style="color: #666;">${notification.created_at}</small>
                    `;
                    container.appendChild(div);
                });
            })
            .catch(error => {
                console.error('Error loading all notifications:', error);
                const container = document.getElementById('allNotificationsList');
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
            });
        }
        
        function markNotificationAsRead(notificationId) {
            const formData = new FormData();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            fetch(`/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
                    updateUnreadCount();
                }
            })
            .catch(error => {
                console.error('Error marking notification as read:', error);
            });
        }
        
        function updateNotificationAppearance(notificationId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø—Ä–µ–≤—å—é
            const previewNotifications = document.querySelectorAll(`#notificationsPreview [onclick="openNotification(${notificationId})"]`);
            previewNotifications.forEach(element => {
                element.classList.remove('notification-unread');
                element.classList.add('notification-read');
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–æ–ª–Ω–æ–º —Å–ø–∏—Å–∫–µ
            const allNotifications = document.querySelectorAll(`#allNotificationsList [onclick="openNotification(${notificationId})"]`);
            allNotifications.forEach(element => {
                element.classList.remove('notification-unread');
                element.classList.add('notification-read');
            });
        }
        
        function updateUnreadCount() {
            const button = document.querySelector('button[onclick="toggleNotifications()"]');
            if (button) {
                const currentText = button.textContent;
                const match = currentText.match(/üîî\((\d+)\)/);
                if (match) {
                    const currentCount = parseInt(match[1]) - 1;
                    if (currentCount > 0) {
                        button.textContent = `üîî(${currentCount})`;
                    } else {
                        button.textContent = 'üîî';
                    }
                }
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
        document.addEventListener('click', function(e) {
            const preview = document.getElementById('notificationsPreview');
            const button = document.querySelector('button[onclick="toggleNotifications()"]');
            
            if (preview && button && !button.contains(e.target) && !preview.contains(e.target)) {
                preview.style.display = 'none';
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
            if (e.target.id === 'allNotificationsModal') {
                closeAllNotifications();
            }
            if (e.target.id === 'notificationModal') {
                closeNotification();
            }
        });
    </script>
</body>
</html>